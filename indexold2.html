<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador de càlcul d'Intensitat, secció i caigudes de tensió</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #f4f4f4;
            --border-color: #ddd;
            --success-color: #28a745;
            --error-color: #dc3545;
            --text-dark: #333;
            --text-light: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }

        .page {
            display: none;
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
        }

        .page.active {
            display: block;
        }

        /* --- ESTILOS LOGIN --- */
        .login-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .login-box {
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .lang-selector {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .lang-selector button {
            background-color: var(--secondary-color);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
        }

        .lang-selector button.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }

        h1, h2 {
            color: var(--primary-color);
        }

        select, input[type="password"], input[type="file"] {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }

        button:hover {
            background-color: #004170;
        }

        .error-message {
            color: var(--error-color);
            margin-top: 10px;
            font-weight: bold;
            min-height: 1.2em;
        }
        
        .test-buttons-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* --- ESTILOS PÁGINAS ALUMNO Y PROFESOR --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            background-color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .student-page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .student-page.active {
            display: block;
        }

        .exercise-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .exercise-card {
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            border-radius: 5px;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .exercise-card p {
            margin: 0;
        }
        
        .exercise-card ul {
            padding-left: 20px;
            margin: 0;
            flex-grow: 1;
        }
        
        .exercise-card li {
            margin-bottom: 5px;
        }

        .exercise-card .formula {
            font-style: italic;
            color: #555;
            background-color: #e9e9e9;
            padding: 5px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 5px;
        }

        .exercise-card .explanation {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
        }

        .exercise-card .result {
            font-weight: bold;
            color: var(--success-color);
        }
        .exercise-card .result.incorrect-result {
            color: var(--error-color);
        }
        .exercise-card .result.optimal-result {
            color: var(--primary-color);
        }

        .exercise-card input[type="text"] {
            width: 100px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            margin-left: 10px;
        }
        
        .exercise-card input.correct {
            border: 2px solid var(--success-color);
            background-color: #f0fff4;
        }

        .exercise-card input.incorrect {
            border: 2px solid var(--error-color);
            background-color: #fff0f0;
        }

        .correction-result {
            margin-top: 10px;
            padding: 8px;
            background-color: #eaf5ff;
            border: 1px solid #bde0ff;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .correction-result .result {
            color: var(--primary-color);
        }

        /* --- ESTILOS PROFESOR --- */
        .teacher-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .teacher-panel > div {
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: var(--primary-color);
            color: var(--text-light);
        }

        tbody tr:nth-child(even) {
            background-color: var(--secondary-color);
        }

        .status-passed {
            color: var(--success-color);
            font-weight: bold;
        }
        .status-pending {
            color: #E8A87C;
            font-weight: bold;
        }
        
        .info {
            font-size: 0.9em;
            color: #666;
        }

        /* Guided Exercise Styles */
        .input-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }

        .guided-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-width: 150px;
        }

        .guided-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .guided-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .check-btn {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .check-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .check-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .feedback {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .feedback.correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.wrong {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .correct-feedback {
            color: #28a745;
        }

        .wrong-feedback {
            color: #dc3545;
        }

        .step-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }

        .step-result p {
            margin: 5px 0;
        }

        .step-result .formula {
            font-family: 'Courier New', monospace;
            background-color: #e9ecef;
            padding: 5px;
            border-radius: 3px;
        }

        /* Navigation button improvements for guided exercises */
        .button-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .button-container button {
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .button-container button:not(:disabled) {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="login-page" class="page active">
        <div class="login-container">
            <h1 data-lang="main_title">Entrenador de càlcul d'Intensitat, secció i caigudes de tensió</h1>
            
            <div class="login-box">
                <h2 data-lang="student_login_title">Accés Alumne</h2>
                <div class="lang-selector">
                    <button id="lang-ca" onclick="setLanguage('ca')">Català</button>
                    <button id="lang-es" onclick="setLanguage('es')">Castellano</button>
                </div>
                <select id="student-select" aria-label="Selecciona el teu nom">
                    <option value="" data-lang="student_select_placeholder">-- Tria el teu nom --</option>
                </select>
                <div id="student-debug" style="color: green; font-size: 12px; margin-top: 5px;"></div>
                <button onclick="login('student')" data-lang="enter_button">Entrar</button>
            </div>

            <div class="login-box">
                <h2 data-lang="teacher_login_title">Accés Professor</h2>
                <input type="password" id="teacher-password" data-lang-placeholder="password_placeholder" placeholder="Contrasenya">
                <button onclick="login('teacher')" data-lang="enter_button">Entrar</button>
                <p id="teacher-error" class="error-message"></p>
            </div>
        </div>
    </div>

    <div id="student-view" class="page">
        <header>
            <h1 id="student-welcome"></h1>
            <div>
                <button id="back-button" onclick="goBack()" data-lang="back_button" style="display: none;">Tornar</button>
                <button onclick="logout()" data-lang="logout_button">Tancar Sessió</button>
            </div>
        </header>

        <div id="selection-page" class="student-page">
            <h2 data-lang="selection_title">Tria el tipus d'exercici</h2>
            <p data-lang="selection_desc">Selecciona quina part vols practicar.</p>
            <div class="test-buttons-container">
                <button onclick="startExercise('intensity')" data-lang="selection_intensity">Càlcul d'Intensitat</button>
                <button onclick="startExercise('section')" data-lang="selection_section">Càlcul de Secció per Caiguda de Tensió</button>
                <button onclick="startExercise('voltage-drop')" data-lang="selection_voltage_drop">Càlcul de Caiguda de Tensió</button>
                <button onclick="startExercise('max-length')" data-lang="selection_max_length">Càlcul de Longitud Màxima</button>
                <button onclick="startExercise('section-intensity')" data-lang="selection_section_intensity">Elecció de Secció per Intensitat (ITC-BT-19)</button>
                <button onclick="startExercise('section-both')" data-lang="selection_section_both">Càlcul de Secció (Intensitat i ΔV)</button>
                <button onclick="startExercise('max-length-both')" data-lang="selection_max_length_both">Càlcul de Longitud Màxima (Intensitat i ΔV)</button>
            </div>
        </div>

        <div id="intensity-examples-page" class="student-page">
            <h2 data-lang="intensity_examples_title">Càlcul d'Intensitat (Exemples)</h2>
            <p data-lang="intensity_examples_desc">Aquí tens 10 exercicis resolts perquè repassis. Quan estiguis a punt, passa al test.</p>
            <div id="intensity-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('intensity-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('intensity-test-page')" data-lang="start_intensity_test_button">Començar Test</button>
            </div>
        </div>

        <div id="intensity-test-page" class="student-page">
            <h2 data-lang="intensity_test_title">Test de Càlcul d'Intensitat</h2>
            <p data-lang="intensity_test_desc">Calcula la intensitat (en amperes) per als 10 casos següents. Fes servir dos decimals i la coma (,) com a separador.</p>
            <div id="intensity-test-container" class="exercise-container"></div>
            <div id="intensity-test-buttons" class="test-buttons-container">
                <button onclick="checkIntensityAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
            <p id="intensity-test-error" class="error-message"></p>
        </div>

        <div id="intensity-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Càlcul d'Intensitat</h2>
            <div id="intensity-guided-container" class="exercise-container">
                <div id="intensity-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="intensity-prev-step" onclick="previousGuidedStep('intensity')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="intensity-next-step" onclick="nextGuidedStep('intensity')" data-lang="next_step">Següent Pas</button>
                <button id="intensity-new-exercise" onclick="generateNewGuidedExercise('intensity')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="section-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Càlcul de Secció</h2>
            <div id="section-guided-container" class="exercise-container">
                <div id="section-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="section-prev-step" onclick="previousGuidedStep('section')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="section-next-step" onclick="nextGuidedStep('section')" data-lang="next_step">Següent Pas</button>
                <button id="section-new-exercise" onclick="generateNewGuidedExercise('section')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="voltage-drop-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Caiguda de Tensió</h2>
            <div id="voltage-drop-guided-container" class="exercise-container">
                <div id="voltage-drop-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="voltage-drop-prev-step" onclick="previousGuidedStep('voltage-drop')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="voltage-drop-next-step" onclick="nextGuidedStep('voltage-drop')" data-lang="next_step">Següent Pas</button>
                <button id="voltage-drop-new-exercise" onclick="generateNewGuidedExercise('voltage-drop')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="max-length-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Longitud Màxima</h2>
            <div id="max-length-guided-container" class="exercise-container">
                <div id="max-length-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="max-length-prev-step" onclick="previousGuidedStep('max-length')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="max-length-next-step" onclick="nextGuidedStep('max-length')" data-lang="next_step">Següent Pas</button>
                <button id="max-length-new-exercise" onclick="generateNewGuidedExercise('max-length')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="section-intensity-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Secció per Intensitat</h2>
            <div id="section-intensity-guided-container" class="exercise-container">
                <div id="section-intensity-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="section-intensity-prev-step" onclick="previousGuidedStep('section-intensity')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="section-intensity-next-step" onclick="nextGuidedStep('section-intensity')" data-lang="next_step">Següent Pas</button>
                <button id="section-intensity-new-exercise" onclick="generateNewGuidedExercise('section-intensity')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="section-both-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Secció per Intensitat i ΔV</h2>
            <div id="section-both-guided-container" class="exercise-container">
                <div id="section-both-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="section-both-prev-step" onclick="previousGuidedStep('section-both')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="section-both-next-step" onclick="nextGuidedStep('section-both')" data-lang="next_step">Següent Pas</button>
                <button id="section-both-new-exercise" onclick="generateNewGuidedExercise('section-both')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="max-length-both-guided-page" class="student-page">
            <h2 data-lang="guided_exercises">Exercicis Guiats - Longitud Màxima per Intensitat i ΔV</h2>
            <div id="max-length-both-guided-container" class="exercise-container">
                <div id="max-length-both-guided-content"></div>
            </div>
            <div class="button-container">
                <button id="max-length-both-prev-step" onclick="previousGuidedStep('max-length-both')" data-lang="previous_step" style="display:none;">Pas Anterior</button>
                <button id="max-length-both-next-step" onclick="nextGuidedStep('max-length-both')" data-lang="next_step">Següent Pas</button>
                <button id="max-length-both-new-exercise" onclick="generateNewGuidedExercise('max-length-both')" data-lang="new_guided_exercise" style="display:none;">Nou Exercici Guiat</button>
            </div>
        </div>

        <div id="section-examples-page" class="student-page">
            <h2 data-lang="section_examples_title">Càlcul de Secció (Exemples)</h2>
            <p data-lang="section_examples_desc">Aquí tens 10 exercicis resolts per repassar el càlcul de seccions.</p>
            <div id="section-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('section-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('section-test-page')" data-lang="start_section_test_button">Començar Test</button>
            </div>
        </div>

        <div id="section-test-page" class="student-page">
            <h2 data-lang="section_test_title">Test de Càlcul de Secció</h2>
            <p data-lang="section_test_desc">Ara calcula la secció del conductor (en mm²) i tria el valor normalitzat igual o superior. Fes servir la coma (,) com a separador decimal si cal.</p>
            <div id="section-test-container" class="exercise-container"></div>
            <div id="section-test-buttons" class="test-buttons-container">
                <button onclick="checkSectionAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
             <p id="section-test-error" class="error-message"></p>
        </div>
        
        <div id="voltage-drop-examples-page" class="student-page">
            <h2 data-lang="voltage_drop_examples_title">Càlcul de Caiguda de Tensió (Exemples)</h2>
            <p data-lang="voltage_drop_examples_desc">Aquí tens 10 exercicis resolts. Calcula la caiguda de tensió i comprova si és admissible.</p>
            <div id="voltage-drop-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('voltage-drop-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('voltage-drop-test-page')" data-lang="start_voltage_drop_test_button">Començar Test</button>
            </div>
        </div>

        <div id="voltage-drop-test-page" class="student-page">
            <h2 data-lang="voltage_drop_test_title">Test de Càlcul de Caiguda de Tensió</h2>
            <p data-lang="voltage_drop_test_desc">Calcula la caiguda de tensió (en %) per als 10 casos següents. Fes servir dos decimals i la coma (,) com a separador.</p>
            <div id="voltage-drop-test-container" class="exercise-container"></div>
            <div id="voltage-drop-test-buttons" class="test-buttons-container">
                <button onclick="checkVoltageDropAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
            <p id="voltage-drop-test-error" class="error-message"></p>
        </div>

        <div id="max-length-examples-page" class="student-page">
            <h2 data-lang="max_length_examples_title">Càlcul de Longitud Màxima (Exemples)</h2>
            <p data-lang="max_length_examples_desc">Aquí tens 10 exercicis resolts on es calcula la longitud màxima d'una línia.</p>
            <div id="max-length-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('max-length-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('max-length-test-page')" data-lang="start_max_length_test_button">Començar Test</button>
            </div>
        </div>

        <div id="max-length-test-page" class="student-page">
            <h2 data-lang="max_length_test_title">Test de Càlcul de Longitud Màxima</h2>
            <p data-lang="max_length_test_desc">Calcula la longitud màxima (en metres) per als 10 casos següents. Fes servir dos decimals i la coma (,) com a separador.</p>
            <div id="max-length-test-container" class="exercise-container"></div>
            <div id="max-length-test-buttons" class="test-buttons-container">
                <button onclick="checkMaxLengthAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
            <p id="max-length-test-error" class="error-message"></p>
        </div>

        <div id="section-intensity-examples-page" class="student-page">
            <h2 data-lang="section_intensity_examples_title">Elecció de Secció per Intensitat (Exemples)</h2>
            <p data-lang="section_intensity_examples_desc">Aquí tens 10 exercicis resolts. Tria la secció normalitzada segons la intensitat màxima admissible per al tipus d'instal·lació.</p>
            <div id="section-intensity-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('section-intensity-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('section-intensity-test-page')" data-lang="start_section_intensity_test_button">Començar Test</button>
            </div>
        </div>

        <div id="section-intensity-test-page" class="student-page">
            <h2 data-lang="section_intensity_test_title">Test d'Elecció de Secció per Intensitat</h2>
            <p data-lang="section_intensity_test_desc">Tria la secció normalitzada (en mm²) per als 10 casos següents segons la ITC-BT-19.</p>
            <div id="section-intensity-test-container" class="exercise-container"></div>
            <div id="section-intensity-test-buttons" class="test-buttons-container">
                <button onclick="checkSectionIntensityAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
            <p id="section-intensity-test-error" class="error-message"></p>
        </div>

        <div id="section-both-examples-page" class="student-page">
            <h2 data-lang="section_both_examples_title">Càlcul de Secció per Intensitat i ΔV (Exemples)</h2>
            <p data-lang="section_both_examples_desc">Aquí tens 10 exercicis resolts. Calcula la secció per intensitat i per caiguda de tensió, i tria la més gran.</p>
            <div id="section-both-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('section-both-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('section-both-test-page')" data-lang="start_section_both_test_button">Començar Test</button>
            </div>
        </div>

        <div id="section-both-test-page" class="student-page">
            <h2 data-lang="section_both_test_title">Test de Càlcul de Secció (Intensitat i ΔV)</h2>
            <p data-lang="section_both_test_desc">Calcula la secció per intensitat i per caiguda de tensió, i tria el valor normalitzat superior de la més gran.</p>
            <div id="section-both-test-container" class="exercise-container"></div>
            <div id="section-both-test-buttons" class="test-buttons-container">
                <button onclick="checkSectionBothAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
            <p id="section-both-test-error" class="error-message"></p>
        </div>

        <div id="max-length-both-examples-page" class="student-page">
            <h2 data-lang="max_length_both_examples_title">Càlcul de Longitud Màxima per Intensitat i ΔV (Exemples)</h2>
            <p data-lang="max_length_both_examples_desc">Aquí tens 10 exercicis resolts. Determina la secció per intensitat i després calcula la longitud màxima per caiguda de tensió.</p>
            <div id="max-length-both-examples-container" class="exercise-container"></div>
            <div class="button-container">
                <button onclick="showPage('max-length-both-guided-page')" data-lang="guided_exercise_button">Exercicis Guiats</button>
                <button onclick="showPage('max-length-both-test-page')" data-lang="start_max_length_both_test_button">Començar Test</button>
            </div>
        </div>

        <div id="max-length-both-test-page" class="student-page">
            <h2 data-lang="max_length_both_test_title">Test de Càlcul de Longitud Màxima (Intensitat i ΔV)</h2>
            <p data-lang="max_length_both_test_desc">Primer, tria la secció mínima per intensitat. Després, calcula la longitud màxima (en metres) per a aquesta secció.</p>
            <div id="max-length-both-test-container" class="exercise-container"></div>
            <div id="max-length-both-test-buttons" class="test-buttons-container">
                <button onclick="checkMaxLengthBothAnswers()" data-lang="check_test_button">Corregir Test</button>
            </div>
            <p id="max-length-both-test-error" class="error-message"></p>
        </div>

        <div id="final-page" class="student-page">
            <h2 data-lang="test_passed_title">Test superat!</h2>
            <p data-lang="test_passed_desc">Has respost correctament a tots els exercicis. Bon treball!</p>
            <button onclick="showPage('selection-page')" data-lang="back_to_menu_button">Tornar al menú</button>
        </div>
    </div>

    <div id="teacher-view" class="page">
        <header>
            <h1 data-lang="teacher_panel_title">Panell del Professor</h1>
            <button onclick="logout()" data-lang="logout_button">Tancar Sessió</button>
        </header>

        <div class="teacher-panel">
            <div>
                <h2 data-lang="upload_list_title">Pujar Llista d'Alumnes</h2>
                <p data-lang="upload_list_desc">Puja un arxiu ODS o CSV amb dues columnes: <strong>nom</strong> i <strong>correu electrònic</strong> (sense capçalera).</p>
                <input type="file" id="file-upload" accept=".ods, .csv">
                <p class="info" data-lang="upload_list_info">Nota: Per a ODS, assegura't que les dades estiguin al primer full de l'arxiu.</p>
            </div>
            
            <div>
                <h2 data-lang="progress_report_title">Informe de Progrés d'Alumnes</h2>
                <div id="progress-report" style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th data-lang="table_student">Alumne</th>
                                <th data-lang="table_email">Correu electrònic</th>
                                <th data-lang="table_intensity_test">Test d'Intensitat</th>
                                <th data-lang="table_section_test">Test de Secció</th>
                                <th data-lang="table_voltage_drop_test">Test de Caiguda de Tensió</th>
                                <th data-lang="table_max_length_test">Test de Longitud Màxima</th>
                                <th data-lang="table_section_intensity_test">Test Secció per Intensitat</th>
                                <th data-lang="table_section_both_test">Test Secció (Ambdós)</th>
                                <th data-lang="table_max_length_both_test">Test Long. Màx. (Ambdós)</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ===================== VARIABLES GLOBALES Y CONSTANTES =====================
        const V_MONOFASICA = 230;
        const V_TRIFASICA = 400;
        const SQRT3 = 1.732;
        const NORMALIZED_SECTIONS = [1.5, 2.5, 4, 6, 10, 16, 25, 35, 50, 70, 95, 120, 150, 185, 240, 300, 400];
        const NORMALIZED_MAGNETOTERMICOS = [10, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125, 160, 200, 250, 255, 260, 265, 270, 275, 280, 285, 290, 295, 300, 305, 310, 315, 320, 325, 330, 335, 340, 345, 350, 355, 360, 365, 370, 375, 380, 385, 390, 395, 400, 405, 410, 415, 420, 425, 430, 435, 440, 445, 450, 455, 460, 465, 470, 475, 480];
        
        // ===================== CONFIGURACIÓN GOOGLE SHEETS =====================
        const GOOGLE_SHEETS_CONFIG = {
            // URL del Google Apps Script Web App (se debe configurar después de crear el script)
            WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbwD-vLyBAPUJ3gQgl1taoQNLCgOz07iv6hvneC2ynehTphAB8f27W3IrT_CNItH-hkr/exec',
            // ID de la hoja de cálculo de Google
            SPREADSHEET_ID: 'YOUR_SPREADSHEET_ID',
            // Configurar en true cuando esté listo para producción
            ENABLED: true, // Cambiado a true para testing
            // Modo debug para mostrar más información
            DEBUG_MODE: true
        };
        
		const AMPACIDAD_ITC_BT_19 = {
			"cobre": {
				"pvc": {
					"A1": {
						"2": { 1.5: 12.5, 2.5: 17, 4: 22, 6: 29, 10: 40, 16: 53, 25: 69},
						"3": { 1.5: 11, 2.5: 15.5, 4: 20, 6: 26, 10: 36, 16: 48, 25: 63 }
					},
					"A2": {
						"2": {1.5: 11, 2.5: 15.5, 4: 20, 6: 26, 10: 36, 16: 48, 25: 63},
						"3": { 1.5: 11, 2.5: 15, 4: 20, 6: 25, 10: 33, 16: 45, 25: 59}
					},
					"B1": {
						"2": { 1.5: 14.5, 2.5: 20, 4: 26, 6: 34, 10: 46, 16: 63, 25: 82, 35: 101, 50: 122, 70: 155, 95: 187, 120: 216,150:247,185:281,240:330 },
						"3": { 1.5: 13.5, 2.5: 18, 4: 24, 6: 31, 10: 43, 16: 59, 25: 77, 35: 95, 50: 116, 70: 148, 95: 180, 120: 207 }
					},
					"B2": {
						"2": { 1.5: 13.5, 2.5: 18, 4: 24, 6: 31, 10: 43, 16: 59, 25: 77, 35: 95, 50: 116, 70: 148, 95: 180, 120: 207 },
						"3": { 1.5: 12.5, 2.5: 17, 4: 22, 6: 29, 10: 40, 16: 53, 25: 69 }
					},
					"C": {
						"2": { 1.5: 17, 2.5: 23, 4: 31, 6: 40, 10: 54, 16: 73, 25: 95, 35: 119, 50: 145, 70: 185, 95: 224, 120: 260, 150: 299,185: 341,240: 401 },
						"3": { 1.5: 14.5, 2.5: 20, 4: 26, 6: 34, 10: 46, 16: 63, 25: 82, 35: 101, 50: 122, 70: 155, 95: 187, 120: 216,150:247,185:281,240:330  }
					},
					"D": {
						"2": {6: 44, 10: 59, 16: 76, 25: 98, 35: 118, 50: 140, 70: 173, 95: 205, 120: 233, 150: 264, 185: 296, 240: 342, 300: 387 },
						"3": { 6: 37, 10: 49, 16: 63, 25: 81, 35: 97, 50: 115, 70: 143, 95: 170, 120: 192, 150: 218, 185: 245, 240: 282, 300: 319 }
					},
					"E": {
						"2": { 1.5: 19, 2.5: 26, 4: 34, 6: 44, 10: 60, 16: 81, 25: 103, 35: 127, 50: 155, 70: 199, 95: 241, 120: 280, 150: 322,185: 368,240: 435 },
						"3": { 1.5: 16, 2.5: 21, 4: 29, 6: 37, 10: 52, 16: 69, 25: 87, 35: 109, 50: 133, 70: 170, 95: 207, 120: 240, 150: 276,185: 314,240: 368  }
					},
					"F": {
						"2": { 1.5: 20, 2.5: 26, 4: 36, 6: 46, 10: 65, 16: 87, 25: 110, 35: 137, 50: 167, 70: 214, 95: 259, 120: 301, 150: 343,185: 391,240: 468 },
						"3": { 1.5: 17, 2.5: 23, 4: 31, 6: 40, 10: 54, 16: 73, 25: 95, 35: 119, 50: 145, 70: 185, 95: 224, 120: 260, 150: 299,185: 341,240: 401 }
					}
				},
				"xlpe": {
					"A1": {
						"2": { 1.5: 16.5, 2.5: 22, 4: 30, 6: 39, 10: 54, 16: 72, 25: 91, 35: 114, 50: 139, 70: 178, 95: 216, 120: 251, 150: 289,185: 329,240: 385 },
						"3": { 1.5: 15.5, 2.5: 20, 4: 28, 6: 36, 10: 49, 16: 66, 25: 86, 35: 106, 50: 128, 70: 162, 95: 196, 120: 226, 150: 259,185: 294,240: 345}
					},
					"A2": {
						"2": { 1.5: 15.5, 2.5: 20, 4: 28, 6: 36, 10: 49, 16: 66, 25: 86, 35: 106, 50: 128, 70: 162, 95: 196, 120: 226, 150: 259,185: 294,240: 345 },
						"3": { 1.5: 14, 2.5: 19, 4: 25, 6: 32, 10: 45, 16: 61, 25: 80, 35: 100, 50: 121, 70: 155, 95: 188, 120: 217 }
					},
					"B1": {
						"2": { 1.5: 20, 2.5: 28, 4: 38, 6: 49, 10: 68, 16: 91, 25: 115, 35: 143, 50: 174, 70: 223, 95: 271, 120: 314, 150: 359,185: 409,240: 489 },
						"3": { 1.5: 17.5, 2.5: 24, 4: 32, 6: 41, 10: 57, 16: 77, 25: 100, 35: 124, 50: 151, 70: 193, 95: 234, 120: 272 ,150: 313,185: 356,240: 419  }
					},
					"B2": {
						"2": { 1.5: 17.5, 2.5: 24, 4: 32, 6: 41, 10: 57, 16: 77, 25: 100, 35: 124, 50: 151, 70: 193, 95: 234, 120: 272 ,150: 313,185: 356,240: 419 },
						"3": { 1.5: 16.5, 2.5: 22, 4: 30, 6: 39, 10: 54, 16: 72, 25: 91, 35: 114, 50: 139, 70: 178, 95: 216, 120: 251, 150: 289,185: 329,240: 385  }
					},
					"C": {
						"2": { 1.5: 21, 2.5: 30, 4: 40, 6: 52, 10: 72, 16: 97, 25: 122, 35: 153, 50: 188, 70: 243, 95: 298, 120: 350, 150: 401,185: 460,240: 545 },
						"3": { 1.5: 20, 2.5: 27, 4: 36, 6: 46, 10: 63, 16: 85, 25: 108, 35: 133, 50: 162, 70: 208, 95: 252, 120: 293, 150: 337,185: 385,240: 455  }
					},
					"D": {
						"2": { 6: 53, 10: 70, 16: 91, 25: 116, 35: 140, 50: 166, 70: 204, 95: 241, 120: 275, 150: 311, 185: 348, 240: 402, 300: 455 },
						"3": { 6: 44, 10: 58, 16: 75, 25: 96, 35: 117, 50: 138, 70: 170, 95: 202, 120: 230, 150: 260, 185: 291, 240: 336, 300: 380 }
					},
					"E": {
						"2": { 1.5: 23, 2.5: 32, 4: 44, 6: 57, 10: 78, 16: 104, 25: 135, 35: 168, 50: 204, 70: 262, 95: 320, 120: 373, 150: 430,185: 493,240: 583 },
						"3": { 1.5: 20, 2.5: 28, 4: 38, 6: 49, 10: 68, 16: 91, 25: 115, 35: 143, 50: 174, 70: 223, 95: 271, 120: 314, 150: 359,185: 409,240: 489}
					},
					"F": {
						"2": { 25: 146, 35: 182, 50: 220, 70: 282, 95: 343, 120: 397, 150: 458,185: 523,240: 617 },
						"3": {  1.5: 21, 2.5: 30, 4: 40, 6: 52, 10: 72, 16: 97, 25: 122, 35: 153, 50: 188, 70: 243, 95: 298, 120: 350, 150: 401,185: 460,240: 545 }
					}
				}
			},
			"aluminio": {
				"pvc": {
					"A1": {
						"2": { 2.5: 13, 4: 17, 6: 22, 10: 31, 16: 41, 25: 54 },
						"3": { 2.5: 12, 4: 16, 6: 20, 10: 27, 16: 37, 25: 49 }
					},
					"A2": {
						"2": { 2.5: 12, 4: 16, 6: 20, 10: 27, 16: 37, 25: 49 },
						"3": { 2.5: 11.5, 4: 15, 6: 20, 10: 26, 16: 35, 25: 46 }
					},
					"B1": {
						"2": { 2.5: 16, 4: 21, 6: 27, 10: 38, 16: 50, 25: 63, 35: 78, 50: 95, 70: 121, 95: 147, 120: 171,150: 196,185: 222,240: 261 },
						"3": { 2.5: 14, 4: 19, 6: 24, 10: 33, 16: 46, 25: 60, 35: 74, 50: 90, 70: 115, 95: 140, 120: 161 }
					},
					"B2": {
						"2": { 2.5: 14, 4: 19, 6: 24, 10: 33, 16: 46, 25: 60, 35: 74, 50: 90, 70: 115, 95: 140, 120: 161 },
						"3": { 2.5: 13, 4: 17, 6: 22, 10: 31, 16: 41, 25: 54 }
					},
					"C": {
						"2": { 2.5: 18, 4: 24, 6: 31, 10: 42, 16: 57, 25: 72, 35: 89, 50: 108, 70: 139, 95: 169, 120: 196,150: 227,185: 259,240: 306 },
						"3": { 2.5: 16, 4: 21, 6: 27, 10: 38, 16: 50, 25: 63, 35: 78, 50: 95, 70: 121, 95: 147, 120: 171,150: 196,185: 222,240: 261 }
					},
					"D": {
						"2": { 2.5: 13, 4: 17, 6: 22, 10: 30, 16: 40, 25: 50, 35: 63, 50: 78, 70: 99, 95: 121, 120: 140, 150: 160, 185: 180, 240: 210, 300: 240 },
						"3": { 2.5: 12, 4: 16, 6: 20, 10: 27, 16: 37, 25: 48, 35: 59, 50: 70, 70: 90, 95: 115, 120: 140, 150: 160, 185: 180, 240: 210, 300: 240 }
					},
					"E": {
						"2": { 2.5: 20, 4: 26, 6: 33, 10: 46, 16: 63, 25: 78, 35: 97, 50: 118, 70: 151, 95: 183, 120: 213, 150: 246, 185: 281, 240: 332 },
						"3": { 2.5: 17, 4: 22, 6: 28, 10: 40, 16: 53, 25: 67, 35: 83, 50: 101, 70: 130, 95: 159, 120: 184, 150: 213, 185: 243, 240: 287 }
					},
					"F": {
						"2": { 2.5: 20, 4: 27, 6: 36, 10: 50, 16: 66, 25: 84, 35: 104, 50: 127, 70: 162, 95: 197, 120: 228, 150: 264, 185: 301, 240: 355 },
						"3": { 2.5: 18, 4: 24, 6: 31, 10: 42, 16: 57, 25: 72, 35: 89, 50: 108, 70: 139, 95: 169, 120: 196,150: 227,185: 259,240: 306 }
					}
				},
				"xlpe": {
					"A1": {
						"2": {2.5: 17.5, 4: 23, 6: 30, 10: 41, 16: 55, 25: 70, 35: 87, 50: 106, 70: 136, 95: 166, 120: 192,150: 222,185: 254,240: 300 },
						"3": {2.5: 16.5, 4: 22, 6: 29, 10: 40, 16: 52, 25: 66, 35: 81, 50: 100, 70: 127, 95: 154, 120: 179, 150: 205,185: 232,240: 273  }
					},
					"A2": {
						"2": { 2.5: 16.5, 4: 22, 6: 29, 10: 40, 16: 52, 25: 66, 35: 81, 50: 100, 70: 127, 95: 154, 120: 179, 150: 205,185: 232,240: 273 },
						"3": {2.5: 15, 4: 20, 6: 25, 10: 35, 16: 48, 25: 63, 35: 78, 50: 94, 70: 121, 95: 146, 120: 169 }
					},
					"B1": {
						"2": { 2.5: 21, 4: 29, 6: 38, 10: 52, 16: 70, 25: 88, 35: 109, 50: 132, 70: 170, 95: 206, 120: 239,150: 276,185: 315,240: 372 },
						"3": { 2.5: 19, 4: 25, 6: 32, 10: 44, 16: 60, 25: 75, 35: 93, 50: 113, 70: 145, 95: 177, 120: 205,150: 237,185: 271,240: 320}
					},
					"B2": {
						"2": { 2.5: 19, 4: 25, 6: 32, 10: 44, 16: 60, 25: 75, 35: 93, 50: 113, 70: 145, 95: 177, 120: 205,150: 237,185: 271,240: 320},
						"3": { 2.5: 17.5, 4: 23, 6: 30, 10: 41, 16: 55, 25: 70, 35: 87, 50: 106, 70: 136, 95: 166, 120: 192,150: 222,185: 254,240: 300 }
					},
					"C": {
						"2": { 2.5: 28, 4: 38, 6: 49, 10: 68, 16: 91, 25: 115, 35: 143, 50: 174, 70: 223, 95: 271, 120: 314 },
						"3": { 2.5: 20, 4: 28, 6: 35, 10: 49, 16: 66, 25: 81, 35: 101, 50: 123, 70: 158, 95: 192, 120: 222, 150: 257,185: 293,240: 347}
					},
					"D": {
						"2": { 16: 70, 25: 89, 35: 107, 50: 126, 70: 156, 95: 185, 120: 211, 150: 239, 185: 267, 240: 309, 300: 349 },
						"3": { 16: 58, 25: 74, 35: 90, 50: 107, 70: 132, 95: 157, 120: 178, 150: 201, 185: 226, 240: 261, 300: 295 }
					},
					"E": {
						"2": { 2.5: 25, 4: 34, 6: 44, 10: 60, 16: 82, 25: 98, 35: 122, 50: 149, 70: 192, 95: 233, 120: 273, 150: 314, 185: 361, 240: 427 },
						"3": { 2.5: 27, 4: 36, 6: 46, 10: 63, 16: 85, 25: 108, 35: 133, 50: 162, 70: 208, 95: 252, 120: 293 }
					},
					"F": {
						"2": {25: 110, 35: 136, 50: 167, 70: 215, 95: 262, 120: 306,150: 353,185: 406,240: 482 },
						"3": { 2.5: 21, 4: 29, 6: 38, 10: 52, 16: 70, 25: 88, 35: 109, 50: 132, 70: 170, 95: 206, 120: 239,150: 276,185: 315,240: 372 }
					}
				}
			}
		};
        const TEACHER_PASS = "profe"; 
        
        let studentList = [
            { id: 'student-0', name: 'Dariel Aguasvivas de Jesus', email: 'email@example.com'},
            { id: 'student-1', name: 'Alfonso Caballero Montiel', email: 'email@example.com'},
            { id: 'student-2', name: 'Andrés Caballero Montiel', email: 'email@example.com'},
            { id: 'student-3', name: 'José Manuel Castaño Herrera', email: 'email@example.com'},
            { id: 'student-4', name: 'Bryan German Carvajal Vargas', email: 'email@example.com'},
            { id: 'student-5', name: 'Mohamed El miri', email: 'email@example.com'},
            { id: 'student-6', name: 'Miguel Alejandro Gonzalez Moreno', email: 'email@example.com'},
            { id: 'student-7', name: 'Marc Jaime Darder', email: 'email@example.com'},
            { id: 'student-8', name: 'Mohamed Kouroma', email: 'email@example.com'},
            { id: 'student-9', name: 'Jaume Lopéz Llull', email: 'email@example.com'},
            { id: 'student-10', name: 'Juan Luis Marquez Gutierrez', email: 'email@example.com'},
            { id: 'student-11', name: 'Sofian Ochen Echahbouni', email: 'email@example.com'},
            { id: 'student-12', name: 'Jeremy Josep Olivares llanos', email: 'email@example.com'},
            { id: 'student-13', name: 'Joan Miquel Oliver Vidal', email: 'email@example.com'},
            { id: 'student-14', name: 'Wasim Ouchen Benali', email: 'email@example.com'},
            { id: 'student-15', name: 'Yamin Ouchen Benali', email: 'email@example.com'}
        ];

        // Function to populate student dropdown - defined early for global access
        function populateStudentSelect() {
            const select = document.getElementById('student-select');
            const debugDiv = document.getElementById('student-debug');
            
            if (!select) {
                if (debugDiv) debugDiv.innerText = 'Error: Element student-select not found';
                console.error('Element student-select not found');
                return;
            }
            if (!studentList || studentList.length === 0) {
                if (debugDiv) debugDiv.innerText = 'Error: studentList is empty or undefined';
                console.error('studentList is empty or undefined:', studentList);
                return;
            }
            
            select.innerHTML = `<option value="">-- Tria el teu nom --</option>`;
            studentList.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.innerText = student.name;
                select.appendChild(option);
            });
            
            if (debugDiv) debugDiv.innerText = `Students loaded: ${studentList.length} students found`;
            console.log('Students populated successfully:', studentList.length, 'students');
        }

        // Function to set language - defined early for global access
        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            
            // Actualizar título del documento
            if (translations[lang] && translations[lang]['main_title']) {
                document.title = translations[lang]['main_title'];
            }
            
            // Actualitzar botons d'idioma
            const langCaBtn = document.getElementById('lang-ca');
            const langEsBtn = document.getElementById('lang-es');
            if (langCaBtn) langCaBtn.classList.toggle('active', lang === 'ca');
            if (langEsBtn) langEsBtn.classList.toggle('active', lang === 'es');
            
            // Actualitzar tots els elements amb data-lang
            document.querySelectorAll('[data-lang]').forEach(element => {
                const key = element.getAttribute('data-lang');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.type === 'password') {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.innerText = translations[lang][key];
                    }
                }
            });
            
            // Actualitzar placeholders
            document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
                const key = element.getAttribute('data-lang-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });
        }

        let currentStudent = null;
        let currentLang = 'ca';
        let currentTestAnswers = {};
        let previousPage = null;

        const translations = {
            ca: {
                main_title: "Entrenador de càlcul d'Intensitat, secció i caigudes de tensió",
                student_login_title: "Accés Alumne",
                teacher_login_title: "Accés Professor",
                student_select_placeholder: "-- Tria el teu nom --",
                enter_button: "Entrar",
                password_placeholder: "Contrasenya",
                selection_title: "Tria el tipus d'exercici",
                selection_desc: "Selecciona quina part vols practicar.",
                selection_intensity: "Càlcul d'Intensitat",
                selection_section: "Càlcul de Secció per Caiguda de Tensió",
                selection_voltage_drop: "Càlcul de Caiguda de Tensió",
                selection_max_length: "Càlcul de Longitud Màxima",
                selection_section_intensity: "Elecció de Secció per Intensitat (ITC-BT-19)",
                selection_section_both: "Càlcul de Secció (Intensitat i ΔV)",
                selection_max_length_both: "Càlcul de Longitud Màxima (Intensitat i ΔV)",
                intensity_examples_title: "Càlcul d'Intensitat (Exemples)",
                intensity_examples_desc: "Aquí tens 10 exercicis resolts perquè repassis. Quan estiguis a punt, passa al test.",
                start_intensity_test_button: "Començar Test",
                intensity_test_title: "Test de Càlcul d'Intensitat",
                intensity_test_desc: "Calcula la intensitat (en amperes) per als 10 casos següents. Fes servir dos decimals i la coma (,) com a separador.",
                check_test_button: "Corregir Test",
                section_examples_title: "Càlcul de Secció (Exemples)",
                section_examples_desc: "Aquí tens 10 exercicis resolts per repassar el càlcul de seccions.",
                start_section_test_button: "Començar Test",
                section_test_title: "Test de Càlcul de Secció",
                section_test_desc: "Ara calcula la secció del conductor (en mm²) i tria el valor normalitzat igual o superior. Fes servir la coma (,) com a separador decimal si cal.",
                voltage_drop_examples_title: "Càlcul de Caiguda de Tensió (Exemples)",
                voltage_drop_examples_desc: "Aquí tens 10 exercicis resolts. Calcula la caiguda de tensió i comprova si és admissible.",
                start_voltage_drop_test_button: "Començar Test",
                voltage_drop_test_title: "Test de Càlcul de Caiguda de Tensió",
                voltage_drop_test_desc: "Calcula la caiguda de tensió (en %) per als 10 casos següents. Fes servir dos decimals i la coma (,) com a separador.",
                max_length_examples_title: "Càlcul de Longitud Màxima (Exemples)",
                max_length_examples_desc: "Aquí tens 10 exercicis resolts on es calcula la longitud màxima d'una línia.",
                start_max_length_test_button: "Començar Test",
                max_length_test_title: "Test de Càlcul de Longitud Màxima",
                max_length_test_desc: "Calcula la longitud màxima (en metres) per als 10 casos següents. Fes servir dos decimals i la coma (,) com a separador.",
                section_intensity_examples_title: "Elecció de Secció per Intensitat (Exemples)",
                section_intensity_examples_desc: "Aquí tens 10 exercicis resolts. Tria la secció normalitzada segons la intensitat màxima admissible per al tipus d'instal·lació.",
                start_section_intensity_test_button: "Començar Test",
                section_intensity_test_title: "Test d'Elecció de Secció per Intensitat",
                section_intensity_test_desc: "Tria la secció normalitzada (en mm²) per als 10 casos següents segons la ITC-BT-19.",
                section_both_examples_title: "Càlcul de Secció per Intensitat i ΔV (Exemples)",
                section_both_examples_desc: "Aquí tens 10 exercicis resolts. Calcula la secció per intensitat i per caiguda de tensió, i tria la més gran.",
                start_section_both_test_button: "Començar Test",
                section_both_test_title: "Test de Càlcul de Secció (Intensitat i ΔV)",
                section_both_test_desc: "Calcula la secció per intensitat i per caiguda de tensió, i tria el valor normalitzat superior de la més gran.",
                max_length_both_examples_title: "Càlcul de Longitud Màxima per Intensitat i ΔV (Exemples)",
                max_length_both_examples_desc: "Aquí tens 10 exercicis resolts. Determina la secció per intensitat i després calcula la longitud màxima per caiguda de tensió.",
                start_max_length_both_test_button: "Començar Test",
                max_length_both_test_title: "Test de Càlcul de Longitud Màxima (Intensitat i ΔV)",
                max_length_both_test_desc: "Primer, tria la secció mínima per intensitat. Després, calcula la longitud màxima (en metres) per a aquesta secció.",
                test_passed_title: "Test superat!",
                test_passed_desc: "Has respost correctament a tots els exercicis. Bon treball!",
                back_to_menu_button: "Tornar al menú",
                teacher_panel_title: "Panell del Professor",
                upload_list_title: "Pujar Llista d'Alumnes",
                upload_list_desc: "Puja un arxiu ODS o CSV amb dues columnes: <strong>nom</strong> i <strong>correu electrònic</strong> (sense capçalera).",
                upload_list_info: "Nota: Per a ODS, assegura't que les dades estiguin al primer full de l'arxiu.",
                progress_report_title: "Informe de Progrés d'Alumnes",
                table_student: "Alumne",
                table_email: "Correu electrònic",
                table_intensity_test: "Test d'Intensitat",
                table_section_test: "Test de Secció",
                table_voltage_drop_test: "Test de Caiguda de Tensió",
                table_max_length_test: "Test de Longitud Màxima",
                table_section_intensity_test: "Test Secció per Intensitat",
                table_section_both_test: "Test Secció (Ambdós)",
                table_max_length_both_test: "Test Long. Màx. (Ambdós)",
                back_button: "Tornar",
                logout_button: "Tancar Sessió",
                welcome_message: "Benvingut/da",
                error_complete_all: "Has de respondre a tots els exercicis per poder corregir.",
                error_wrong_password: "Contrasenya incorrecta.",
                // Exercise labels
                exercise_question: "Pregunta:",
                exercise_resolution: "Resolució:",
                exercise_step: "Pas",
                exercise_case: "Cas",
                // Intensity questions
                calc_intensity_trifasic: "Calcula la intensitat per a un receptor trifàsic de",
                calc_intensity_monofasic: "Calcula la intensitat per a un receptor monofàsic de", 
                with_voltage: "amb una tensió de",
                and_cos_phi: "i un cos(φ) de",
                calculated_intensity: "La intensitat calculada és",
                // Section questions
                calc_section_copper: "Calcula la secció d'un conductor de coure per a una línia",
                calc_section_aluminum: "Calcula la secció d'un conductor d'alumini per a una línia",
                calc_intensity_with_conductor: "Calcula la intensitat d'una línia amb conductor de",
                with_conductor: "amb conductor de",
                trifasic: "trifàsica",
                monofasic: "monofàsica",
                that_feeds_motor: "que alimenta un motor de",
                that_feeds_circuit: "que alimenta un circuit de",
                lighting: "enllumenat",
                power: "força",
                max_voltage_drop_calc: "Càlcul de la caiguda de tensió màxima admissible:",
                section_calc: "Càlcul de la secció:",
                calculated_section: "Secció calculada:",
                normalized_section: "Secció normalitzada:",
                correct_section: "La secció correcta és",
                // Max length questions
                calc_max_length: "Calcula la longitud màxima (en metres) d'una línia",
                for_circuit: "per a un circuit d'",
                max_length: "Longitud màxima:",
                // Units
                unit_watts: "W",
                unit_volts: "V", 
                unit_amperes: "A",
                unit_mm2: "mm²",
                unit_meters: "m",
                unit_percent: "%",
                // Input labels
                input_intensity: "Intensitat",
                input_section_calc: "Secció calculada",
                input_section_norm: "Secció normalitzada",
                input_voltage_drop: "Caiguda de tensió",
                input_max_length: "Longitud màxima",
                input_admissible: "És admissible?",
                option_yes: "Sí",
                option_no: "No",
                // Results
                correct_result: "Resultat correcte",
                is_admissible: "És",
                not_admissible: "NO ADMISSIBLE",
                // Materials
                material_copper: "coure",
                material_aluminum: "alumini",
                // Section intensity questions
                choose_min_section: "Tria la secció mínima d'un conductor de",
                with_insulation: "amb aïllament",
                for_line: "per a una línia",
                with_calculated_intensity: "amb una intensitat calculada de",
                installation_method: "El mètode d'instal·lació és",
                installation_system: "El sistema d'instal·lació és",
                circuit_type: "per a un circuit d'",
                search_table: "Busquem a la taula de la ITC-BT-19 per a",
                method: "mètode",
                line: "línia",
                first_section_supports: "La primera secció que suporta",
                or_more: "o més és",
                supports_up_to: "suporta fins a",
                // Max length both steps
                calc_section_by_intensity: "Càlcul de la secció per intensitat:",
                calc_max_length_voltage_drop: "Càlcul de la longitud màxima per caiguda de tensió:",
                calculated_intensity: "Intensitat calculada",
                min_section_intensity: "Secció mínima per intensitat",
                using_section: "Utilitzant la secció de",
                max_length_no_exceed: "la longitud màxima per no superar la caiguda de tensió és de",
                // Detailed calculation labels
                normalized_breaker: "Intensitat normalitzada del magnetotèrmic",
                section_selection: "Selecció de secció segons taula ITC-BT-19",
                max_voltage_drop_calc: "Càlcul de la caiguda de tensió màxima admissible",
                max_length_calc: "Càlcul de la longitud màxima",
                // Step labels
                step_1: "Pas 1",
                step_2: "Pas 2",
                section_calc_step: "Càlcul de la secció",
                voltage_drop_volts_calc: "Càlcul de la caiguda de tensió en volts",
                voltage_drop_percent_calc: "Càlcul de la caiguda de tensió porcentual",
                voltage_drop_volts_step: "Caiguda de tensió en volts",
                voltage_drop_percent_step: "Caiguda de tensió porcentual",
                max_length: "Longitud màxima",
                normalized_breaker_step: "Intensitat normalitzada del magnetotèrmic",
                voltage_drop_result: "La caiguda de tensió és",
                intensity_calc: "Càlcul de la intensitat",
                receptor: "receptor",
                conclusion: "Conclusió",
                choose_larger_section: "Es tria la secció més gran entre",
                min_regulatory_section: "Secció mínima reglamentària",
                individual_derivation: "(derivació individual)",
                lga_aluminum: "(LGA alumini)",
                lga_copper: "(LGA coure)",
                final_correct_section: "La secció final correcta és",
                and: "i",
                guided_exercises: "Exercicis Guiats",
                guided_exercise_button: "Exercicis Guiats",
                guided_exercise_step: "Pas",
                new_guided_exercise: "Nou Exercici Guiat",
                step_by_step: "Pas a pas",
                next_step: "Següent Pas",
                previous_step: "Pas Anterior",
                finish_exercise: "Finalitzar Exercici",
                formula_to_use: "Fórmula a utilitzar",
                where: "On",
                substitute_values: "Substituir valors",
                final_calculation: "Càlcul final",
                answer: "Resposta",
                calculate_voltage_drop: "Calcular la caiguda de tensió",
                select_commercial_section: "Seleccionar secció comercial",
                calculated_section: "Secció calculada",
                available_sections: "Seccions disponibles",
                percentage_calculation: "Càlcul del percentatge",
                under_development: "En desenvolupament",
                statement: "Enunciat",
                formula: "Fórmula",
                substitution: "Substitució",
                result: "Resultat",
                correct_answer: "¡Correcte!",
                incorrect_answer: "Incorrecte. Torna-ho a intentar",
                correct_answer_is: "La resposta correcta és",
                attempt_of: "intent",
                of: "de",
                calculate_result: "Calcula el resultat",
                power: "Potència",
                voltage: "Tensió",
                intensity: "Intensitat",
                cosine: "Cosinus",
                calculate: "Calcular",
                resistivity: "Resistivitat",
                length: "Longitud",
                section: "Secció",
                voltage_drop: "Caiguda de tensió",
                max_voltage_drop: "Caiguda de tensió màxima",
                calc_section_by_intensity: "Càlcul de la secció per intensitat",
                calc_max_length_voltage_drop: "Càlcul de la longitud màxima per caiguda de tensió",
                min_section_intensity: "Secció mínima per intensitat",
                using_section: "Utilitzant la secció de",
                calculate_denominator: "Calcula el denominador",
                calculate_voltage_drop_volts: "Calcula la caiguda de tensió en volts",
                calculate_voltage_drop_percentage: "Calcula la caiguda de tensió en percentatge",
                calculate_max_voltage_drop_volts: "Calcula la caiguda de tensió màxima en volts",
                calculate_max_length_result: "Calcula la longitud màxima",
                normalized_magnetothermic_value: "Quin és el valor normalitzat igual o superior a",
                first_section_supports_current: "Quina és la primera secció que suporta",
                or_more_current: "o més",
                final_section_larger: "Quina és la secció final (la més gran)",
                what_is_max_length: "Quina és la longitud màxima",
                introduce_result: "Introdueix el resultat",
                introduce_result_volts: "Introdueix el resultat en V",
                introduce_result_percentage: "Introdueix el resultat en %",
                introduce_result_amperes: "Introdueix el resultat en A",
                introduce_section_mm2: "Introdueix la secció en mm²",
                introduce_result_meters: "Introdueix el resultat en m",
                verify_button: "Verificar"
            },
            es: {
                main_title: "Entrenador de cálculo de Intensidad, sección y caídas de tensión",
                student_login_title: "Acceso Alumno",
                teacher_login_title: "Acceso Profesor",
                student_select_placeholder: "-- Elige tu nombre --",
                enter_button: "Entrar",
                password_placeholder: "Contraseña",
                selection_title: "Elige el tipo de ejercicio",
                selection_desc: "Selecciona qué parte quieres practicar.",
                selection_intensity: "Cálculo de Intensidad",
                selection_section: "Cálculo de Sección por Caída de Tensión",
                selection_voltage_drop: "Cálculo de Caída de Tensión",
                selection_max_length: "Cálculo de Longitud Máxima",
                selection_section_intensity: "Elección de Sección por Intensidad (ITC-BT-19)",
                selection_section_both: "Cálculo de Sección (Intensidad y ΔV)",
                selection_max_length_both: "Cálculo de Longitud Máxima (Intensidad y ΔV)",
                intensity_examples_title: "Cálculo de Intensidad (Ejemplos)",
                intensity_examples_desc: "Aquí tienes 10 ejercicios resueltos para que repases. Cuando estés listo, pasa al test.",
                start_intensity_test_button: "Empezar Test",
                intensity_test_title: "Test de Cálculo de Intensidad",
                intensity_test_desc: "Calcula la intensidad (en amperios) para los 10 casos siguientes. Usa dos decimales y la coma (,) como separador.",
                check_test_button: "Corregir Test",
                section_examples_title: "Cálculo de Sección (Ejemplos)",
                section_examples_desc: "Aquí tienes 10 ejercicios resueltos para repasar el cálculo de secciones.",
                start_section_test_button: "Empezar Test",
                section_test_title: "Test de Cálculo de Sección",
                section_test_desc: "Ahora calcula la sección del conductor (en mm²) y elige el valor normalizado igual o superior. Usa la coma (,) como separador decimal si es necesario.",
                voltage_drop_examples_title: "Cálculo de Caída de Tensión (Ejemplos)",
                voltage_drop_examples_desc: "Aquí tienes 10 ejercicios resueltos. Calcula la caída de tensión y comprueba si es admisible.",
                start_voltage_drop_test_button: "Empezar Test",
                voltage_drop_test_title: "Test de Cálculo de Caída de Tensión",
                voltage_drop_test_desc: "Calcula la caída de tensión (en %) para los 10 casos siguientes. Usa dos decimales y la coma (,) como separador.",
                max_length_examples_title: "Cálculo de Longitud Máxima (Ejemplos)",
                max_length_examples_desc: "Aquí tienes 10 ejercicios resueltos donde se calcula la longitud máxima de una línea.",
                start_max_length_test_button: "Empezar Test",
                max_length_test_title: "Test de Cálculo de Longitud Máxima",
                max_length_test_desc: "Calcula la longitud máxima (en metros) para los 10 casos siguientes. Usa dos decimales y la coma (,) como separador.",
                section_intensity_examples_title: "Elección de Sección por Intensidad (Ejemplos)",
                section_intensity_examples_desc: "Aquí tienes 10 ejercicios resueltos. Elige la sección normalizada según la intensidad máxima admisible para el tipo de instalación.",
                start_section_intensity_test_button: "Empezar Test",
                section_intensity_test_title: "Test de Elección de Sección por Intensidad",
                section_intensity_test_desc: "Elige la sección normalizada (en mm²) para los 10 casos siguientes según la ITC-BT-19.",
                section_both_examples_title: "Cálculo de Sección por Intensidad y ΔV (Ejemplos)",
                section_both_examples_desc: "Aquí tienes 10 ejercicios resueltos. Calcula la sección por intensidad y por caída de tensión, y elige la mayor.",
                start_section_both_test_button: "Empezar Test",
                section_both_test_title: "Test de Cálculo de Sección (Intensidad y ΔV)",
                section_both_test_desc: "Calcula la sección por intensidad y por caída de tensión, y elige el valor normalizado superior de la mayor.",
                max_length_both_examples_title: "Cálculo de Longitud Máxima por Intensidad y ΔV (Ejemplos)",
                max_length_both_examples_desc: "Aquí tienes 10 ejercicios resueltos. Determina la sección por intensidad y después calcula la longitud máxima por caída de tensión.",
                start_max_length_both_test_button: "Empezar Test",
                max_length_both_test_title: "Test de Cálculo de Longitud Máxima (Intensidad y ΔV)",
                max_length_both_test_desc: "Primero, elige la sección mínima por intensidad. Luego, calcula la longitud máxima (en metros) para esa sección.",
                test_passed_title: "¡Test superado!",
                test_passed_desc: "Has respondido correctamente a todos los ejercicios. ¡Buen trabajo!",
                back_to_menu_button: "Volver al menú",
                teacher_panel_title: "Panel del Profesor",
                upload_list_title: "Subir Lista de Alumnos",
                upload_list_desc: "Sube un archivo ODS o CSV con dos columnas: <strong>nombre</strong> y <strong>correo electrónico</strong> (sin cabecera).",
                upload_list_info: "Nota: Para ODS, asegúrate de que los datos estén en la primera hoja del archivo.",
                progress_report_title: "Informe de Progreso de Alumnos",
                table_student: "Alumno",
                table_email: "Correo electrónico",
                table_intensity_test: "Test de Intensidad",
                table_section_test: "Test de Sección",
                table_voltage_drop_test: "Test de Caída de Tensión",
                table_max_length_test: "Test de Longitud Máxima",
                table_section_intensity_test: "Test Sección por Intensidad",
                table_section_both_test: "Test Sección (Ambos)",
                table_max_length_both_test: "Test Long. Máx. (Ambos)",
                back_button: "Volver",
                logout_button: "Cerrar Sesión",
                welcome_message: "Bienvenido/a",
                error_complete_all: "Debes responder a todos los ejercicios para poder corregir.",
                error_wrong_password: "Contraseña incorrecta.",
                // Exercise labels  
                exercise_question: "Pregunta:",
                exercise_resolution: "Resolución:",
                exercise_step: "Paso",
                exercise_case: "Caso",
                // Intensity questions
                calc_intensity_trifasic: "Calcula la intensidad para un receptor trifásico de",
                calc_intensity_monofasic: "Calcula la intensidad para un receptor monofásico de",
                with_voltage: "con una tensión de", 
                and_cos_phi: "y un cos(φ) de",
                calculated_intensity: "La intensidad calculada es",
                // Section questions
                calc_section_copper: "Calcula la sección de un conductor de cobre para una línea",
                calc_section_aluminum: "Calcula la sección de un conductor de aluminio para una línea",
                calc_intensity_with_conductor: "Calcula la intensidad de una línea con conductor de",
                with_conductor: "con conductor de",
                trifasic: "trifásica",
                monofasic: "monofásica", 
                that_feeds_motor: "que alimenta un motor de",
                that_feeds_circuit: "que alimenta un circuito de",
                lighting: "alumbrado",
                power: "fuerza",
                max_voltage_drop_calc: "Cálculo de la caída de tensión máxima admisible:",
                section_calc: "Cálculo de la sección:",
                calculated_section: "Sección calculada:",
                normalized_section: "Sección normalizada:",
                correct_section: "La sección correcta es",
                // Max length questions
                calc_max_length: "Calcula la longitud máxima (en metros) de una línea",
                for_circuit: "para un circuito de",
                max_length: "Longitud máxima:",
                // Units
                unit_watts: "W",
                unit_volts: "V",
                unit_amperes: "A", 
                unit_mm2: "mm²",
                unit_meters: "m",
                unit_percent: "%",
                // Input labels
                input_intensity: "Intensidad",
                input_section_calc: "Sección calculada",
                input_section_norm: "Sección normalizada",
                input_voltage_drop: "Caída de tensión",
                input_max_length: "Longitud máxima",
                input_admissible: "¿Es admisible?",
                option_yes: "Sí",
                option_no: "No",
                // Results
                correct_result: "Resultado correcto",
                is_admissible: "Es",
                not_admissible: "NO ADMISIBLE",
                // Materials
                material_copper: "cobre",
                material_aluminum: "aluminio",
                // Section intensity questions
                choose_min_section: "Elige la sección mínima de un conductor de",
                with_insulation: "con aislamiento",
                for_line: "para una línea",
                with_calculated_intensity: "con una intensidad calculada de",
                installation_method: "El método de instalación es",
                installation_system: "El sistema de instalación es",
                circuit_type: "para un circuito de",
                search_table: "Buscamos en la tabla de la ITC-BT-19 para",
                method: "método",
                line: "línea",
                first_section_supports: "La primera sección que soporta",
                or_more: "o más es",
                supports_up_to: "soporta hasta",
                // Max length both steps  
                calc_section_by_intensity: "Cálculo de la sección por intensidad:",
                calc_max_length_voltage_drop: "Cálculo de la longitud máxima por caída de tensión:",
                calculated_intensity: "Intensidad calculada",
                min_section_intensity: "Sección mínima por intensidad",
                using_section: "Utilizando la sección de",
                max_length_no_exceed: "la longitud máxima para no superar la caída de tensión es de",
                // Detailed calculation labels
                normalized_breaker: "Intensidad normalizada del magnetotérmico",
                section_selection: "Selección de sección según tabla ITC-BT-19",
                max_voltage_drop_calc: "Cálculo de la caída de tensión máxima admisible",
                max_length_calc: "Cálculo de la longitud máxima",
                // Step labels
                step_1: "Paso 1",
                step_2: "Paso 2",
                section_calc_step: "Cálculo de la sección",
                voltage_drop_volts_calc: "Cálculo de la caída de tensión en volts",
                voltage_drop_percent_calc: "Cálculo de la caída de tensión porcentual",
                voltage_drop_volts_step: "Caída de tensión en volts",
                voltage_drop_percent_step: "Caída de tensión porcentual",
                max_length: "Longitud máxima",
                normalized_breaker_step: "Intensidad normalizada del magnetotérmico",
                voltage_drop_result: "La caída de tensión es",
                intensity_calc: "Cálculo de la intensidad",
                receptor: "receptor",
                conclusion: "Conclusión",
                choose_larger_section: "Se elige la sección más grande entre",
                min_regulatory_section: "Sección mínima reglamentaria",
                individual_derivation: "(derivación individual)",
                lga_aluminum: "(LGA aluminio)",
                lga_copper: "(LGA cobre)",
                final_correct_section: "La sección final correcta es",
                and: "y",
                guided_exercises: "Ejercicios Guiados",
                guided_exercise_button: "Ejercicios Guiados",
                guided_exercise_step: "Paso",
                new_guided_exercise: "Nuevo Ejercicio Guiado",
                step_by_step: "Paso a paso",
                next_step: "Siguiente Paso",
                previous_step: "Paso Anterior",
                finish_exercise: "Finalizar Ejercicio",
                formula_to_use: "Fórmula a utilizar",
                where: "Donde",
                substitute_values: "Sustituir valores",
                final_calculation: "Cálculo final",
                answer: "Respuesta",
                calculate_voltage_drop: "Calcular la caída de tensión",
                select_commercial_section: "Seleccionar sección comercial",
                calculated_section: "Sección calculada",
                available_sections: "Secciones disponibles",
                percentage_calculation: "Cálculo del porcentaje",
                under_development: "En desarrollo",
                statement: "Enunciado",
                formula: "Fórmula",
                substitution: "Sustitución",
                result: "Resultado",
                correct_answer: "¡Correcto!",
                incorrect_answer: "Incorrecto. Inténtalo de nuevo",
                correct_answer_is: "La respuesta correcta es",
                attempt_of: "intento",
                of: "de",
                calculate_result: "Calcula el resultado",
                power: "Potencia",
                voltage: "Tensión",
                intensity: "Intensidad",
                cosine: "Coseno",
                calculate: "Calcular",
                resistivity: "Resistividad",
                length: "Longitud",
                section: "Sección",
                voltage_drop: "Caída de tensión",
                max_voltage_drop: "Caída de tensión máxima",
                calc_section_by_intensity: "Cálculo de la sección por intensidad",
                calc_max_length_voltage_drop: "Cálculo de la longitud máxima por caída de tensión",
                min_section_intensity: "Sección mínima por intensidad",
                using_section: "Utilizando la sección de",
                calculate_denominator: "Calcula el denominador",
                calculate_voltage_drop_volts: "Calcula la caída de tensión en voltios",
                calculate_voltage_drop_percentage: "Calcula la caída de tensión en porcentaje",
                calculate_max_voltage_drop_volts: "Calcula la caída de tensión máxima en voltios",
                calculate_max_length_result: "Calcula la longitud máxima",
                normalized_magnetothermic_value: "¿Cuál es el valor normalizado igual o superior a",
                first_section_supports_current: "¿Cuál es la primera sección que soporta",
                or_more_current: "o más",
                final_section_larger: "¿Cuál es la sección final (la mayor)",
                what_is_max_length: "¿Cuál es la longitud máxima",
                introduce_result: "Introduce el resultado",
                introduce_result_volts: "Introduce el resultado en V",
                introduce_result_percentage: "Introduce el resultado en %",
                introduce_result_amperes: "Introduce el resultado en A",
                introduce_section_mm2: "Introduce la sección en mm²",
                introduce_result_meters: "Introduce el resultado en m",
                verify_button: "Verificar"
            }
        };


        // ===================== INICIALIZACIÓN =====================
        document.addEventListener('DOMContentLoaded', () => {
            const fileUpload = document.getElementById('file-upload');
            if (fileUpload) {
                fileUpload.addEventListener('change', handleFileUpload);
            }
            
            // Cargar la lista de alumnos por defecte
            populateStudentSelect();
            initializeStudentProgress();
            renderProgressReport();

            loadStudentProgress();
            setLanguage(currentLang); 
        });

        // ===================== GESTIÓ DE PÀGINES =====================
        function showPage(pageId) {
            // Ocultar todas las vistas principales
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('student-view').classList.remove('active');
            document.getElementById('teacher-view').classList.remove('active');
            
            // Ocultar todas las páginas de estudiante
            document.querySelectorAll('.student-page').forEach(page => page.style.display = 'none');
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                // Mostrar la vista de estudiante y la página específica
                document.getElementById('student-view').classList.add('active');
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
                
                // Generate guided exercise if this is a guided page
                if (pageId.includes('-guided-page')) {
                    const exerciseType = pageId.replace('-guided-page', '');
                    generateNewGuidedExercise(exerciseType);
                }
                
                // Mostrar botó de tornar si no és la pàgina de selecció
                const backButton = document.getElementById('back-button');
                if (pageId !== 'selection-page') {
                    previousPage = document.querySelector('.student-page.active:not(#' + pageId + ')')?.id || 'selection-page';
                    backButton.style.display = 'inline-block';
                } else {
                    backButton.style.display = 'none';
                }
            } else {
                // Si no se encuentra la página, mostrar login
                document.getElementById('login-page').classList.add('active');
            }
        }

        function goBack() {
            const currentPage = document.querySelector('.student-page.active').id;
            let backTarget = 'selection-page';

            if (currentPage.includes('-test-')) {
                backTarget = currentPage.replace('-test-', '-examples-');
            }
            
            showPage(backTarget);
        }

        // ===================== LÒGICA DE LOGIN/LOGOUT =====================
        function login(role) {
            if (role === 'student') {
                const studentId = document.getElementById('student-select').value;
                if (studentId) {
                    currentStudent = studentList.find(s => s.id === studentId);
                    document.getElementById('student-welcome').innerText = `${translations[currentLang]['welcome_message']}, ${currentStudent.name}`;
                    showPage('selection-page');
                }
            } else if (role === 'teacher') {
                const password = document.getElementById('teacher-password').value;
                if (password === TEACHER_PASS) {
                    document.getElementById('login-page').classList.remove('active');
                    document.getElementById('teacher-view').classList.add('active');
                    document.getElementById('teacher-error').innerText = "";
                } else {
                    document.getElementById('teacher-error').innerText = translations[currentLang]['error_wrong_password'];
                }
            }
        }

        function logout() {
            currentStudent = null;
            document.getElementById('teacher-password').value = "";
            
            // Ocultar todas las vistas principales
            document.getElementById('login-page').classList.remove('active');
            document.getElementById('student-view').classList.remove('active');
            document.getElementById('teacher-view').classList.remove('active');
            
            // Ocultar todas las páginas de estudiante
            document.querySelectorAll('.student-page').forEach(page => page.style.display = 'none');
            
            // Mostrar la página de login
            document.getElementById('login-page').classList.add('active');
        }
        
        // ===================== LÒGICA DE PROFESOR =====================
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = function(e) {
                let data = e.target.result;
                if (fileExtension === 'ods') {
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processStudentData(jsonData);
                } else if (fileExtension === 'csv') {
                    const workbook = XLSX.read(data, {type: 'string'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processStudentData(jsonData);
                }
            };

            if (fileExtension === 'ods') {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function processStudentData(data) {
            studentList = data.map((row, index) => ({
                id: `student-${index}`,
                name: row[0],
                email: row[1]
            }));
            
            populateStudentSelect();
            initializeStudentProgress();
            renderProgressReport();
        }
        
        // ===================== LÒGICA DE PROGRESO DE ALUMNOS =====================
        function initializeStudentProgress() {
            let progress = JSON.parse(localStorage.getItem('studentProgress')) || {};
            studentList.forEach(student => {
                if (!progress[student.id]) {
                    progress[student.id] = {
                        name: student.name,
                        email: student.email,
                        intensityTest: 'Pendent',
                        sectionTest: 'Pendent',
                        voltageDropTest: 'Pendent',
                        maxLengthTest: 'Pendent',
                        sectionIntensityTest: 'Pendent',
                        sectionBothTest: 'Pendent',
                        maxLengthBothTest: 'Pendent'
                    };
                }
            });
            localStorage.setItem('studentProgress', JSON.stringify(progress));
        }

        function saveStudentProgress(testKey) {
            if (!currentStudent) return;
            let progress = JSON.parse(localStorage.getItem('studentProgress')) || {};
            if (progress[currentStudent.id]) {
                progress[currentStudent.id][testKey] = 'Superat';
                localStorage.setItem('studentProgress', JSON.stringify(progress));
            }
            if (document.getElementById('teacher-view').classList.contains('active')) {
                renderProgressReport();
            }
        }

        function loadStudentProgress() {
            const progress = JSON.parse(localStorage.getItem('studentProgress'));
            if (progress) {
                 renderProgressReport();
            }
        }
        
        // ===================== FUNCIONES DE GOOGLE SHEETS =====================
        async function sendTestReportToGoogleSheets(testType, testData) {
            if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                console.log('=== GOOGLE SHEETS DEBUG ===');
                console.log('ENABLED:', GOOGLE_SHEETS_CONFIG.ENABLED);
                console.log('WEB_APP_URL:', GOOGLE_SHEETS_CONFIG.WEB_APP_URL);
                console.log('Current Student:', currentStudent);
                console.log('Test Type:', testType);
                console.log('Test Data:', testData);
            }
            
            if (!GOOGLE_SHEETS_CONFIG.ENABLED) {
                console.log('❌ Google Sheets reporting is DISABLED. Set ENABLED: true in GOOGLE_SHEETS_CONFIG');
                if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                    alert('Google Sheets está deshabilitado. Para activarlo:\n1. Configura WEB_APP_URL con tu URL de Google Apps Script\n2. Configura SPREADSHEET_ID con tu ID de hoja\n3. Cambia ENABLED a true');
                }
                return;
            }
            
            if (!currentStudent) {
                console.log('❌ No student selected');
                if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                    alert('No hay alumno seleccionado');
                }
                return;
            }
            
            if (!GOOGLE_SHEETS_CONFIG.WEB_APP_URL || GOOGLE_SHEETS_CONFIG.WEB_APP_URL.includes('YOUR_SCRIPT_ID')) {
                console.log('❌ WEB_APP_URL not configured properly');
                if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                    alert('URL de Google Apps Script no configurada correctamente. Revisa las instrucciones en INSTRUCCIONES_GOOGLE_SHEETS.md');
                }
                return;
            }
            
            try {
                const reportData = {
                    timestamp: new Date().toISOString(),
                    studentName: currentStudent.name,
                    studentEmail: currentStudent.email,
                    testType: testType,
                    language: currentLang,
                    questions: testData.questions,
                    userAnswers: testData.userAnswers,
                    correctAnswers: testData.correctAnswers,
                    detailedResults: testData.detailedResults,
                    score: testData.score,
                    totalQuestions: testData.totalQuestions,
                    passed: testData.passed
                };
                
                if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                    console.log('📤 Sending data to Google Sheets...', reportData);
                }
                
                const response = await fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reportData),
                    mode: 'no-cors' // Necesario para Google Apps Script
                });
                
                console.log('✅ Test report sent to Google Sheets successfully');
                
                // Mostrar notificación visual al usuario
                if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                    showNotification('✅ Informe enviado a Google Sheets correctamente', 'success');
                }
                
            } catch (error) {
                console.error('❌ Error sending test report to Google Sheets:', error);
                if (GOOGLE_SHEETS_CONFIG.DEBUG_MODE) {
                    showNotification('❌ Error enviando informe a Google Sheets: ' + error.message, 'error');
                }
            }
        }
        
        // Función para mostrar notificaciones visuales
        function showNotification(message, type = 'info') {
            // Crear elemento de notificación
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            // Estilos según el tipo
            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else {
                notification.style.backgroundColor = '#007bff';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Eliminar después de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        function collectTestData(testType, testContainer, answers, checkFunction) {
            const questions = [];
            const userAnswers = [];
            const correctAnswers = [];
            const detailedResults = [];
            let score = 0;
            
            // Recopilar datos según el tipo de test
            for (let i = 0; i < 10; i++) {
                const questionDiv = document.querySelector(`#${testContainer} .exercise-card:nth-child(${i + 1})`);
                const questionText = questionDiv ? questionDiv.querySelector('p:first-child')?.textContent || '' : '';
                
                let userAnswer = '';
                let correctAnswer = '';
                let isCorrect = false;
                let resolution = '';
                
                switch (testType) {
                    case 'intensity':
                        const intensityInput = document.getElementById(`intensity-answer-${i}`);
                        userAnswer = intensityInput ? intensityInput.value : '';
                        const questionData = currentTestAnswers[`intensity-answer-${i}`];
                        correctAnswer = questionData.answer;
                        isCorrect = Math.abs(parseFloat(userAnswer.replace(',', '.')) - correctAnswer) < 0.1;
                        
                        let formula, calculation;
                        if (questionData.isTrifasic) {
                            formula = 'I = P / (V * √3 * cos(φ))';
                            calculation = `I = ${questionData.P} / (${questionData.V} * ${SQRT3.toFixed(3)} * ${questionData.cosPhi})`;
                        } else {
                            formula = 'I = P / (V * cos(φ))';
                            calculation = `I = ${questionData.P} / (${questionData.V} * ${questionData.cosPhi})`;
                        }
                        resolution = `Fórmula: ${formula}<br>Substitució: ${calculation}<br>Resultat: I = ${correctAnswer.toFixed(2)} A`;
                        break;
                        
                    case 'section':
                        const sectionCalcInput = document.getElementById(`section-calculated-answer-${i}`);
                        const sectionNormInput = document.getElementById(`section-normalized-answer-${i}`);
                        userAnswer = `Calculada: ${sectionCalcInput?.value || ''}, Normalizada: ${sectionNormInput?.value || ''}`;
                        const correctCalc = currentTestAnswers[`section-calculated-answer-${i}`];
                        const correctNorm = currentTestAnswers[`section-normalized-answer-${i}`];
                        correctAnswer = `Calculada: ${correctCalc.toFixed(2)}, Normalizada: ${correctNorm}`;
                        const userCalc = parseFloat(sectionCalcInput?.value.replace(',', '.') || '0');
                        const userNorm = parseFloat(sectionNormInput?.value || '0');
                        isCorrect = Math.abs(userCalc - correctCalc) < 0.1 && userNorm === correctNorm;
                        resolution = `S = ${correctCalc.toFixed(2)} mm² → ${correctNorm} mm² (normalizada)`;
                        break;
                        
                    case 'voltage-drop':
                        const voltageDropInput = document.getElementById(`voltage-drop-answer-${i}`);
                        const admissibleInput = document.getElementById(`admissible-answer-${i}`);
                        userAnswer = `${voltageDropInput?.value || ''}%, ${admissibleInput?.value === 'true' ? 'Sí' : 'No'}`;
                        const correctDrop = currentTestAnswers[`voltage-drop-answer-${i}`];
                        const correctAdmissible = currentTestAnswers[`admissible-answer-${i}`];
                        correctAnswer = `${correctDrop.toFixed(2)}%, ${correctAdmissible ? 'Sí' : 'No'}`;
                        const userDrop = parseFloat(voltageDropInput?.value.replace(',', '.') || '0');
                        const userAdmissible = admissibleInput?.value === 'true';
                        isCorrect = Math.abs(userDrop - correctDrop) < 0.1 && userAdmissible === correctAdmissible;
                        resolution = `ΔV = ${correctDrop.toFixed(2)}% (${correctAdmissible ? 'ADMISIBLE' : 'NO ADMISIBLE'})`;
                        break;
                        
                    case 'max-length':
                        const maxLengthInput = document.getElementById(`max-length-answer-${i}`);
                        userAnswer = `${maxLengthInput?.value || ''} m`;
                        correctAnswer = currentTestAnswers[`max-length-answer-${i}`];
                        isCorrect = Math.abs(parseFloat(maxLengthInput?.value.replace(',', '.') || '0') - correctAnswer) < 1;
                        resolution = `L máx = ${correctAnswer.toFixed(2)} m`;
                        break;
                        
                    case 'section-intensity':
                        const sectionIntensityInput = document.getElementById(`section-intensity-answer-${i}`);
                        userAnswer = `${sectionIntensityInput?.value || ''} mm²`;
                        correctAnswer = currentTestAnswers[`section-intensity-answer-${i}`];
                        isCorrect = parseFloat(sectionIntensityInput?.value || '0') === correctAnswer;
                        resolution = `S = ${correctAnswer} mm² (según ITC-BT-19)`;
                        break;
                        
                    case 'section-both':
                        const sectionBothInput = document.getElementById(`section-both-answer-${i}`);
                        userAnswer = `${sectionBothInput?.value || ''} mm²`;
                        correctAnswer = currentTestAnswers[`section-both-answer-${i}`];
                        isCorrect = parseFloat(sectionBothInput?.value || '0') === correctAnswer;
                        resolution = `S = ${correctAnswer} mm² (mayor entre intensidad y ΔV)`;
                        break;
                        
                    case 'max-length-both':
                        const maxLengthBothInput = document.getElementById(`max-length-both-answer-${i}`);
                        userAnswer = `${maxLengthBothInput?.value || ''} m`;
                        correctAnswer = currentTestAnswers[`max-length-both-answer-${i}`];
                        isCorrect = Math.abs(parseFloat(maxLengthBothInput?.value.replace(',', '.') || '0') - correctAnswer) < 1;
                        resolution = `L máx = ${correctAnswer.toFixed(2)} m (considerando intensidad)`;
                        break;
                }
                
                if (isCorrect) score++;
                
                questions.push(questionText);
                userAnswers.push(userAnswer);
                correctAnswers.push(correctAnswer);
                detailedResults.push({
                    questionNumber: i + 1,
                    question: questionText,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    resolution: resolution,
                    isCorrect: isCorrect
                });
            }
            
            return {
                questions,
                userAnswers,
                correctAnswers,
                detailedResults,
                score,
                totalQuestions: 10,
                passed: score === 10
            };
        }
        
        // ===================== FUNCIÓN DE TEST MANUAL PARA GOOGLE SHEETS =====================
        // Esta función se puede ejecutar desde la consola del navegador para hacer pruebas
        function testGoogleSheetsConnection() {
            console.log('🧪 Testing Google Sheets connection...');
            
            // Crear datos de prueba
            const testData = {
                questions: ['Pregunta de prueba 1', 'Pregunta de prueba 2'],
                userAnswers: ['15.5 A', '2.5 mm²'],
                correctAnswers: ['15.75 A', '2.5 mm²'],
                detailedResults: [
                    {
                        questionNumber: 1,
                        question: 'Calcula la intensidad para un receptor trifásico de 5000 W',
                        userAnswer: '15.5 A',
                        correctAnswer: '15.75 A',
                        resolution: 'I = P / (V * √3 * cos(φ)) = 5000 / (400 * 1.732 * 0.9) = 15.75 A',
                        isCorrect: false
                    },
                    {
                        questionNumber: 2,
                        question: 'Calcula la sección de un conductor de cobre',
                        userAnswer: '2.5 mm²',
                        correctAnswer: '2.5 mm²',
                        resolution: 'S = 2.5 mm² (normalizada)',
                        isCorrect: true
                    }
                ],
                score: 1,
                totalQuestions: 2,
                passed: false
            };
            
            // Simular un estudiante
            if (!currentStudent) {
                console.log('⚠️ No hay alumno seleccionado. Creando alumno de prueba...');
                currentStudent = {
                    name: 'Alumno de Prueba',
                    email: 'prueba@test.com'
                };
            }
            
            // Enviar datos de prueba
            sendTestReportToGoogleSheets('test-connection', testData);
            
            console.log('🧪 Test enviado. Revisa la consola para ver los logs y Google Sheets para verificar que llegaron los datos.');
        }
        
        // Hacer la función accesible globalmente para poder ejecutarla desde la consola
        window.testGoogleSheetsConnection = testGoogleSheetsConnection;

        // ===================== GENERACIÓ DE NÚMEROS ALEATORIS =====================
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomFloat(min, max, decimals) {
            const str = (Math.random() * (max - min) + min).toFixed(decimals);
            return parseFloat(str);
        }

        function getRandomValue(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // Secciones normalizadas para ejercicios guiados
        const sections = NORMALIZED_SECTIONS;
        
        function getRandomFromList(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        // ===================== FUNCIÓN DE CONDUCTIVIDAD =====================
        function getConductivity(material, insulation) {
            if (material === 'aluminio') {
                return insulation === 'pvc' ? 29.67 : 27.80; // PVC: 29.67, XLPE: 27.80
            } else { // copper
                return insulation === 'pvc' ? 48.47 : 45.49; // PVC: 48.47, XLPE: 45.49
            }
        }

        // ===================== FUNCIÓN DE DESCRIPCIÓN DE INSTALACIÓN =====================
        function getInstallationDescription(method) {
            const descriptions = {
                ca: {
                    'A1': 'conductors aïllats en tubs encastats en paret tèrmica',
                    'A2': 'cable multiconductor en tub encastat en paret tèrmica',
                    'B1': 'conductors aïllats en tubs en muntatge superficial o empotrats en obra',
                    'B2': 'cable multiconductor en tub en muntatge superficial o empotrat en obra',
                    'C': 'cables directament fixats sobre parets o sostres',
                    'D': 'cables multiconductors en canaleta ventilada',
                    'E': 'cables multiconductors a l\'aire lliure',
                    'F': 'cables unipoles espaciats a l\'aire lliure'
                },
                es: {
                    'A1': 'conductores aislados en tubos empotrados en pared térmica',
                    'A2': 'cable multiconductor en tubo empotrado en pared térmica',
                    'B1': 'conductores aislados en tubos en montaje superficial o empotrados en obra',
                    'B2': 'cable multiconductor en tubo en montaje superficial o empotrado en obra',
                    'C': 'cables directamente fijados sobre paredes o techos',
                    'D': 'cables multiconductores en canaleta ventilada',
                    'E': 'cables multiconductores al aire libre',
                    'F': 'cables unipolares espaciados al aire libre'
                }
            };
            return descriptions[currentLang][method] || (currentLang === 'ca' ? 'sistema d\'instal·lació estàndard' : 'sistema de instalación estándar');
        }

        // ===================== FUNCIÓN DE SECCIÓN MÍNIMA SEGÚN TIPO DE CIRCUITO =====================
        function getMinimumSection(circuitType, material) {
            // Sección mínima para derivaciones individuales: 6mm²
            if (circuitType.startsWith('individual_')) {
                return 6;
            }
            
            // Sección mínima para LGA: 10mm² (cobre) o 16mm² (aluminio)
            if (circuitType.startsWith('lga_')) {
                return material === 'aluminio' ? 16 : 10;
            }
            
            // Para otros tipos de circuito, usar la primera sección normalizada
            return NORMALIZED_SECTIONS[0];
        }

        // ===================== FUNCIÓN PARA APLICAR SECCIÓN MÍNIMA =====================
        function applyMinimumSection(calculatedSection, circuitType, material) {
            const minSection = getMinimumSection(circuitType, material);
            const effectiveSection = Math.max(calculatedSection, minSection);
            
            // Encontrar la sección normalizada igual o superior
            return NORMALIZED_SECTIONS.find(s => s >= effectiveSection) || NORMALIZED_SECTIONS[NORMALIZED_SECTIONS.length - 1];
        }

        // ===================== FUNCIÓN DE TIPOS DE CIRCUITO Y CAÍDAS DE TENSIÓN =====================
        function getCircuitTypeAndDrop(isMonophasic = false) {
            const circuitTypes = [
                { type: 'lighting', name_ca: 'enllumenat', name_es: 'alumbrado', maxDrop: 3 },
                { type: 'power_non_residential', name_ca: 'força (no vivenda)', name_es: 'fuerza (no vivienda)', maxDrop: 5 },
                { type: 'power_residential', name_ca: 'força (vivenda)', name_es: 'fuerza (vivienda)', maxDrop: 3 },
                { type: 'individual_single_meter', name_ca: 'derivació individual (comptador únic)', name_es: 'derivación individual (contador único)', maxDrop: 1.5 },
                { type: 'individual_centralized', name_ca: 'derivació individual (comptadors totalment centralitzats)', name_es: 'derivación individual (contadores totalmente centralizados)', maxDrop: 1 },
                { type: 'individual_partial_centralized', name_ca: 'derivació individual (comptadors parcialment centralitzats)', name_es: 'derivación individual (contadores parcialmente centralizados)', maxDrop: 0.5 },
                { type: 'lga_centralized', name_ca: 'LGA (comptadors totalment centralitzats)', name_es: 'LGA (contadores totalmente centralizados)', maxDrop: 0.5 },
                { type: 'lga_partial_centralized', name_ca: 'LGA (comptadors parcialment centralitzats)', name_es: 'LGA (contadores parcialmente centralizados)', maxDrop: 1 }
            ];
            
            // Filter out LGA circuits if the line is monophasic
            let availableCircuits = circuitTypes;
            if (isMonophasic) {
                availableCircuits = circuitTypes.filter(circuit => 
                    !circuit.type.startsWith('lga_')
                );
            }
            
            const selectedCircuit = getRandomFromList(availableCircuits);
            const circuitName = currentLang === 'ca' ? selectedCircuit.name_ca : selectedCircuit.name_es;
            
            return {
                type: selectedCircuit.type,
                name: circuitName,
                maxDropPercent: selectedCircuit.maxDrop,
                isLighting: selectedCircuit.type === 'lighting',
                isLGA: selectedCircuit.type.startsWith('lga_'),
                isIndividualDerivation: selectedCircuit.type.startsWith('individual_')
            };
        }

        // ===================== LÒGICA DE EXERCICIS =====================
        function startExercise(type) {
            let examplePage, testPage;
            let generateExamplesFn, generateTestFn;

            switch(type) {
                case 'intensity':
                    examplePage = 'intensity-examples-page';
                    generateExamplesFn = generateIntensityExamples;
                    generateTestFn = generateIntensityTest;
                    break;
                case 'section':
                    examplePage = 'section-examples-page';
                    generateExamplesFn = generateSectionExamples;
                    generateTestFn = generateSectionTest;
                    break;
                case 'voltage-drop':
                    examplePage = 'voltage-drop-examples-page';
                    generateExamplesFn = generateVoltageDropExamples;
                    generateTestFn = generateVoltageDropTest;
                    break;
                case 'max-length':
                    examplePage = 'max-length-examples-page';
                    generateExamplesFn = generateMaxLengthExamples;
                    generateTestFn = generateMaxLengthTest;
                    break;
                case 'section-intensity':
                    examplePage = 'section-intensity-examples-page';
                    generateExamplesFn = generateSectionIntensityExamples;
                    generateTestFn = generateSectionIntensityTest;
                    break;
                case 'section-both':
                    examplePage = 'section-both-examples-page';
                    generateExamplesFn = generateSectionBothExamples;
                    generateTestFn = generateSectionBothTest;
                    break;
                case 'max-length-both':
                    examplePage = 'max-length-both-examples-page';
                    generateExamplesFn = generateMaxLengthBothExamples;
                    generateTestFn = generateMaxLengthBothTest;
                    break;
            }

            if (generateExamplesFn) generateExamplesFn();
            if (generateTestFn) generateTestFn();
            if (examplePage) showPage(examplePage);
        }

        // ----------------- Bloque 1: Cálculo de Intensidad -----------------
        
        function generateIntensityQuestion() {
            const isTrifasic = Math.random() > 0.5;
            const P = getRandomInt(1000, 10000);
            const V = isTrifasic ? V_TRIFASICA : V_MONOFASICA;
            const cosPhi = getRandomFloat(0.8, 1, 2);
            
            // 2 out of 10 exercises should use aluminum
            const material = Math.random() < 0.2 ? 'aluminio' : 'cobre';
            const materialText = material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
            
            // Add insulation information
            const insulation = Math.random() > 0.5 ? 'pvc' : 'xlpe';
            
            let question, answer;

            if (isTrifasic) {
                question = `${translations[currentLang]['calc_intensity_trifasic']} ${P} ${translations[currentLang]['unit_watts']} ${translations[currentLang]['and_cos_phi']} ${cosPhi}.`;
                answer = P / (V * SQRT3 * cosPhi);
            } else {
                question = `${translations[currentLang]['calc_intensity_monofasic']} ${P} ${translations[currentLang]['unit_watts']} ${translations[currentLang]['and_cos_phi']} ${cosPhi}.`;
                answer = P / (V * cosPhi);
            }
            
            // Debug: log the question to see if insulation appears
            console.log('Block 3 Question:', question);
            console.log('Material:', materialText, 'Insulation:', insulation.toUpperCase());
            
            // Encontrar el valor normalizado superior
            const normalized = NORMALIZED_MAGNETOTERMICOS.find(val => val >= answer) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1];

            return { question, answer, normalized, isTrifasic, P, V, cosPhi, material, insulation };
        }

        function generateIntensityExamples() {
            const container = document.getElementById('intensity-examples-container');
            container.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const { question, answer, isTrifasic, P, V, cosPhi, material, insulation } = generateIntensityQuestion();
                const formula = isTrifasic 
                    ? `I = P / (V * √3 * cos(φ)) = ${P} / (${V} * ${SQRT3.toFixed(3)} * ${cosPhi}) = ${answer.toFixed(2)} A`
                    : `I = P / (V * cos(φ)) = ${P} / (${V} * ${cosPhi}) = ${answer.toFixed(2)} A`;

                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${question}</p>
                        <p class="explanation"><span class="formula">${formula}</span></p>
                        <p class="result"><strong>${translations[currentLang]['exercise_resolution']}</strong> ${translations[currentLang]['calculated_intensity']} ${answer.toFixed(2)} ${translations[currentLang]['unit_amperes']}.</p>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        function generateIntensityTest() {
            const container = document.getElementById('intensity-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const questionData = generateIntensityQuestion();
                currentTestAnswers[`intensity-answer-${i}`] = questionData;
                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_case']} ${i + 1}:</strong> ${questionData.question}</p>
                        <p>${translations[currentLang]['input_intensity']} (${translations[currentLang]['unit_amperes']}): <input type="text" id="intensity-answer-${i}" class="answer-input"></p>
                        <div id="correction-intensity-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
            document.getElementById('intensity-test-error').innerText = "";
        }

        function checkIntensityAnswers() {
            let allCorrect = true;
            let filledCount = 0;
            const inputs = document.querySelectorAll('#intensity-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

            if (filledCount < inputs.length) {
                document.getElementById('intensity-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('intensity-test-error').innerText = "";


            for (let i = 0; i < 10; i++) {
                const inputId = `intensity-answer-${i}`;
                const userInput = parseFloat(document.getElementById(inputId).value.replace(',', '.'));
                const correctAnswer = currentTestAnswers[inputId].answer;
                const inputElement = document.getElementById(inputId);
                const correctionDiv = document.getElementById(`correction-intensity-${i}`);

                if (Math.abs(userInput - correctAnswer) < 0.1) {
                    inputElement.classList.add('correct');
                    inputElement.classList.remove('incorrect');
                    correctionDiv.style.display = 'none';
                } else {
                    inputElement.classList.add('incorrect');
                    inputElement.classList.remove('correct');
                    correctionDiv.innerHTML = `${translations[currentLang]['correct_result']}: <span class="result">${correctAnswer.toFixed(2)} ${translations[currentLang]['unit_amperes']}</span>.`;
                    correctionDiv.style.display = 'block';
                    allCorrect = false;
                }
            }
            
            // Recopilar datos del test y enviar informe
            const testData = collectTestData('intensity', 'intensity-test-container', currentTestAnswers, checkIntensityAnswers);
            sendTestReportToGoogleSheets('intensity', testData);
            
            if (allCorrect) {
                saveStudentProgress('intensityTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }


        // ----------------- Bloque 2: Cálculo de Sección por Caída de Tensión -----------------

        function generateSectionQuestion() {
            const isTrifasic = Math.random() > 0.5;
            const P = getRandomInt(1000, 20000); // W
            const L = getRandomInt(10, 200); // m
            const cosPhi = getRandomFloat(0.85, 1, 2);
            const V = isTrifasic ? V_TRIFASICA : V_MONOFASICA;
            const circuitInfo = getCircuitTypeAndDrop(!isTrifasic); // Pass isMonophasic parameter
            const maxVoltageDropPercent = circuitInfo.maxDropPercent;
            const maxVoltageDrop = V * (maxVoltageDropPercent / 100);
            
            // 2 out of 10 exercises should use aluminum
            const material = Math.random() < 0.2 ? 'aluminio' : 'cobre';
            const materialText = material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
            const sectionKey = material === 'aluminio' ? 'calc_section_aluminum' : 'calc_section_copper';
            
            // Add insulation information
            const insulation = Math.random() > 0.5 ? 'pvc' : 'xlpe';
            const conductividad = getConductivity(material, insulation);
            
            let question, calculatedSection;

            if (isTrifasic) {
                question = `${translations[currentLang][sectionKey]} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()} ${translations[currentLang]['trifasic']} de ${L} ${translations[currentLang]['unit_meters']} per a un circuit de ${circuitInfo.name} de ${P} ${translations[currentLang]['unit_watts']}.`;
                calculatedSection = (P * L) / (conductividad * V * maxVoltageDrop);
            } else {
                question = `${translations[currentLang][sectionKey]} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()} ${translations[currentLang]['monofasic']} de ${L} ${translations[currentLang]['unit_meters']} per a un circuit de ${circuitInfo.name} de ${P} ${translations[currentLang]['unit_watts']}.`;
                calculatedSection = (2 * P * L) / (conductividad * V * maxVoltageDrop);
            }

            // Apply minimum section restrictions
            const normalizedSection = applyMinimumSection(calculatedSection, circuitInfo.type, material);

            return { question, calculatedSection, normalizedSection, isTrifasic, P, L, V, cosPhi, maxVoltageDropPercent, material, conductividad, insulation, circuitType: circuitInfo.type, circuitName: circuitInfo.name };
        }


        function generateSectionExamples() {
            const container = document.getElementById('section-examples-container');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const q = generateSectionQuestion();
                const conductividad = getConductivity(q.material, q.insulation);
                const vDrop = (q.V * q.maxVoltageDropPercent / 100).toFixed(2);
                const vDropCalculation = `ΔV = V * (${q.maxVoltageDropPercent}% / 100) = ${q.V} * (${q.maxVoltageDropPercent} / 100) = ${vDrop} V`;
                const formula = q.isTrifasic
                    ? `S = (P * L) / (γ * V * ΔV) = (${q.P} * ${q.L}) / (${conductividad} * ${q.V} * ${vDrop}) = ${q.calculatedSection.toFixed(2)} mm²`
                    : `S = (2 * P * L) / (γ * V * ΔV) = (2 * ${q.P} * ${q.L}) / (${conductividad} * ${q.V} * ${vDrop}) = ${q.calculatedSection.toFixed(2)} mm²`;

                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${q.question}</p>
                        <p class="explanation"><strong>${translations[currentLang]['step_1']}:</strong> ${translations[currentLang]['max_voltage_drop_calc']}:</p>
                        <p class="explanation"><span class="formula">${vDropCalculation}</span></p>
                        <p class="explanation"><strong>${translations[currentLang]['step_2']}:</strong> ${translations[currentLang]['section_calc_step']}:</p>
                        <p class="explanation"><span class="formula">${formula}</span></p>
                        <p><strong>${translations[currentLang]['exercise_resolution']}:</strong></p>
                        <ul>
                            <li>${translations[currentLang]['calculated_section']}: ${q.calculatedSection.toFixed(2)} mm²</li>
                            <li class="result">${translations[currentLang]['normalized_section']}: ${q.normalizedSection} mm²</li>
                        </ul>
                    </div>
                `;
                container.innerHTML += card;
            }
        }
        
        function generateSectionTest() {
            const container = document.getElementById('section-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const { question, calculatedSection, normalizedSection } = generateSectionQuestion();
                currentTestAnswers[`section-calculated-answer-${i}`] = calculatedSection;
                currentTestAnswers[`section-normalized-answer-${i}`] = normalizedSection;
                const card = `
                    <div class="exercise-card">
                        <p><strong>Cas ${i + 1}:</strong> ${question}</p>
                        <div>Secció calculada (mm²): <input type="text" id="section-calculated-answer-${i}" class="answer-input"></div>
                        <div>Secció normalitzada (mm²): 
                            <select id="section-normalized-answer-${i}" class="answer-input">
                                ${NORMALIZED_SECTIONS.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                         <div id="correction-section-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
            document.getElementById('section-test-error').innerText = "";
        }

        function checkSectionAnswers() {
            let allCorrect = true;
            let filledCount = 0;
            const inputs = document.querySelectorAll('#section-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

            if (filledCount < inputs.length) {
                document.getElementById('section-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('section-test-error').innerText = "";


            for (let i = 0; i < 10; i++) {
                const calculatedInput = document.getElementById(`section-calculated-answer-${i}`);
                const normalizedInput = document.getElementById(`section-normalized-answer-${i}`);
                const correctionDiv = document.getElementById(`correction-section-${i}`);

                const userCalculated = parseFloat(calculatedInput.value.replace(',', '.'));
                const userNormalized = parseFloat(normalizedInput.value);

                const correctCalculated = currentTestAnswers[`section-calculated-answer-${i}`];
                const correctNormalized = currentTestAnswers[`section-normalized-answer-${i}`];
                
                let isCalculatedCorrect = Math.abs(userCalculated - correctCalculated) < 0.1;
                let isNormalizedCorrect = userNormalized === correctNormalized;

                calculatedInput.classList.toggle('correct', isCalculatedCorrect);
                calculatedInput.classList.toggle('incorrect', !isCalculatedCorrect);

                normalizedInput.classList.toggle('correct', isNormalizedCorrect);
                normalizedInput.classList.toggle('incorrect', !isNormalizedCorrect);

                if (!isCalculatedCorrect || !isNormalizedCorrect) {
                    allCorrect = false;
                    correctionDiv.innerHTML = `Resultat correcte: 
                        <span class="result">${correctCalculated.toFixed(2)} mm²</span> (calculada) i 
                        <span class="result">${correctNormalized} mm²</span> (normalitzada).`;
                    correctionDiv.style.display = 'block';
                } else {
                     correctionDiv.style.display = 'none';
                }
            }

            // Recopilar datos del test y enviar informe
            const testData = collectTestData('section', 'section-test-container', currentTestAnswers, checkSectionAnswers);
            sendTestReportToGoogleSheets('section', testData);

            if (allCorrect) {
                saveStudentProgress('sectionTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }


        // ----------------- Bloque 3: Cálculo de Caída de Tensión (en %) -----------------
        function generateVoltageDropQuestion() {
            let isTrifasic, P, L, S, cosPhi, V, voltageDrop, voltageDropPercent;
            let attempts = 0;
            const maxAttempts = 100;
            
            // 2 out of 10 exercises should use aluminum
            const material = Math.random() < 0.2 ? 'aluminio' : 'cobre';
            const materialText = material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
            
            // Add insulation information
            const insulation = Math.random() > 0.5 ? 'pvc' : 'xlpe';
            
            do {
                isTrifasic = Math.random() > 0.5;
                P = getRandomInt(1000, 15000); // W
                L = getRandomInt(10, 250); // m
                S = getRandomFromList(NORMALIZED_SECTIONS.slice(0, 10)); // mm²
                cosPhi = getRandomFloat(0.8, 1, 2);
                V = isTrifasic ? V_TRIFASICA : V_MONOFASICA;
                const conductividad = getConductivity(material, insulation);
                
                if (isTrifasic) {
                    voltageDrop = (P * L) / (conductividad * S * V);
                } else {
                    voltageDrop = (2 * P * L) / (conductividad * S * V);
                }
                
                voltageDropPercent = (voltageDrop / V) * 100;
                attempts++;
            } while (voltageDropPercent > 20 && attempts < maxAttempts);
            
            let question;
            if (isTrifasic) {
                question = `${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()}: Calcula la caiguda de tensió (en %) per a una línia trifàsica de ${L}m, secció ${S}mm², que alimenta un ${translations[currentLang]['receptor']} de ${P}W.`;
            } else {
                question = `${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()}: Calcula la caiguda de tensió (en %) per a una línia monofàsica de ${L}m, secció ${S}mm², que alimenta un ${translations[currentLang]['receptor']} de ${P}W.`;
            }

            const circuitInfo = getCircuitTypeAndDrop(!isTrifasic); // Pass isMonophasic parameter
            const maxDropPercent = circuitInfo.maxDropPercent;
            const isAdmissible = voltageDropPercent <= maxDropPercent;
            
            question += ` El circuit és de ${circuitInfo.name}.`;

            return { question, voltageDropPercent, voltageDrop, isTrifasic, P, L, S, V, cosPhi, isAdmissible, maxDropPercent, material, insulation, circuitType: circuitInfo.type, circuitName: circuitInfo.name };
        }

        function generateVoltageDropExamples() {
            const container = document.getElementById('voltage-drop-examples-container');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const q = generateVoltageDropQuestion();
                const conductividad = getConductivity(q.material, q.insulation);
                const voltageDropFormula = q.isTrifasic 
                    ? `ΔV = (P * L) / (γ * S * V) = (${q.P} * ${q.L}) / (${conductividad} * ${q.S} * ${q.V}) = ${q.voltageDrop.toFixed(2)} V`
                    : `ΔV = (2 * P * L) / (γ * S * V) = (2 * ${q.P} * ${q.L}) / (${conductividad} * ${q.S} * ${q.V}) = ${q.voltageDrop.toFixed(2)} V`;
                
                const percentageFormula = `ΔV% = (ΔV / V) * 100 = (${q.voltageDrop.toFixed(2)} / ${q.V}) * 100 = ${q.voltageDropPercent.toFixed(2)}%`;

                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${q.question}</p>
                        <p class="explanation"><strong>${translations[currentLang]['step_1']}:</strong> ${translations[currentLang]['voltage_drop_volts_calc']}:</p>
                        <p class="explanation"><span class="formula">${voltageDropFormula}</span></p>
                        <p class="explanation"><strong>${translations[currentLang]['step_2']}:</strong> ${translations[currentLang]['voltage_drop_percent_calc']}:</p>
                        <p class="explanation"><span class="formula">${percentageFormula}</span></p>
                        <p><strong>${translations[currentLang]['exercise_resolution']}:</strong></p>
                        <ul>
                            <li>${translations[currentLang]['step_1']} - ${translations[currentLang]['voltage_drop_volts_step']}: ${q.voltageDrop.toFixed(2)} V</li>
                            <li>${translations[currentLang]['step_2']} - ${translations[currentLang]['voltage_drop_percent_step']}: ${q.voltageDropPercent.toFixed(2)} %</li>
                            <li>${translations[currentLang]['max_voltage_drop_calc']}: ${q.maxDropPercent} %</li>
                            <li class="result ${q.isAdmissible ? '' : 'incorrect-result'}">${translations[currentLang]['voltage_drop_result']} ${q.isAdmissible ? translations[currentLang]['is_admissible'] : translations[currentLang]['not_admissible']}.</li>
                        </ul>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        function generateVoltageDropTest() {
            const container = document.getElementById('voltage-drop-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const q = generateVoltageDropQuestion();
                currentTestAnswers[`voltage-drop-answer-${i}`] = q.voltageDropPercent;
                currentTestAnswers[`admissible-answer-${i}`] = q.isAdmissible;
                const card = `
                    <div class="exercise-card">
                        <p><strong>Cas ${i + 1}:</strong> ${q.question}</p>
                        <div>Caiguda de tensió (%): <input type="text" id="voltage-drop-answer-${i}" class="answer-input"></div>
                        <div>
                            És admissible?
                            <select id="admissible-answer-${i}" class="answer-input">
                                <option value="true">Sí</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div id="correction-voltage-drop-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
             document.getElementById('voltage-drop-test-error').innerText = "";
        }

        function checkVoltageDropAnswers() {
            let allCorrect = true;
             let filledCount = 0;
            const inputs = document.querySelectorAll('#voltage-drop-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

            if (filledCount < inputs.length) {
                document.getElementById('voltage-drop-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('voltage-drop-test-error').innerText = "";

            for (let i = 0; i < 10; i++) {
                const dropInput = document.getElementById(`voltage-drop-answer-${i}`);
                const admissibleInput = document.getElementById(`admissible-answer-${i}`);
                const correctionDiv = document.getElementById(`correction-voltage-drop-${i}`);

                const userDrop = parseFloat(dropInput.value.replace(',', '.'));
                const userAdmissible = admissibleInput.value === 'true';

                const correctDrop = currentTestAnswers[`voltage-drop-answer-${i}`];
                const correctAdmissible = currentTestAnswers[`admissible-answer-${i}`];

                let isDropCorrect = Math.abs(userDrop - correctDrop) < 0.1;
                let isAdmissibleCorrect = userAdmissible === correctAdmissible;
                
                dropInput.classList.toggle('correct', isDropCorrect);
                dropInput.classList.toggle('incorrect', !isDropCorrect);

                admissibleInput.classList.toggle('correct', isAdmissibleCorrect);
                admissibleInput.classList.toggle('incorrect', !isAdmissibleCorrect);

                if (!isDropCorrect || !isAdmissibleCorrect) {
                    allCorrect = false;
                    correctionDiv.innerHTML = `Resultat correcte: 
                        <span class="result">${correctDrop.toFixed(2)} %</span>. 
                        És <span class="result">${correctAdmissible ? 'ADMISSIBLE' : 'NO ADMISSIBLE'}</span>.`;
                    correctionDiv.style.display = 'block';
                } else {
                    correctionDiv.style.display = 'none';
                }
            }
            
            // Recopilar datos del test y enviar informe
            const testData = collectTestData('voltage-drop', 'voltage-drop-test-container', currentTestAnswers, checkVoltageDropAnswers);
            sendTestReportToGoogleSheets('voltage-drop', testData);
            
            if (allCorrect) {
                saveStudentProgress('voltageDropTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }
        
        // ----------------- Bloque 4: Cálculo de Longitud Máxima -----------------
        function generateMaxLengthQuestion() {
            const isTrifasic = Math.random() > 0.5;
            const P = getRandomInt(1000, 10000); // W
            const cosPhi = getRandomFloat(0.9, 1, 2);
            const V = isTrifasic ? V_TRIFASICA : V_MONOFASICA;
            const circuitInfo = getCircuitTypeAndDrop(!isTrifasic); // Pass isMonophasic parameter
            const maxDropPercent = circuitInfo.maxDropPercent;
            const maxVoltageDrop = V * (maxDropPercent / 100);
            
            // 2 out of 10 exercises should use aluminum
            const material = Math.random() < 0.2 ? 'aluminio' : 'cobre';
            const materialText = material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
            
            // Add insulation information
            const insulation = Math.random() > 0.5 ? 'pvc' : 'xlpe';
            const conductividad = getConductivity(material, insulation);
            
            // Get minimum section for this circuit type and material
            const minSection = getMinimumSection(circuitInfo.type, material);
            
            // Choose a section that meets the minimum requirement
            const availableSections = NORMALIZED_SECTIONS.filter(s => s >= minSection).slice(0, 8);
            const S = getRandomFromList(availableSections);
            
            let question, maxLength;
            
            if (isTrifasic) {
                maxLength = (conductividad * S * V * maxVoltageDrop) / (P);
                question = `${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()}: Calcula la longitud màxima (en metres) d'una línia trifàsica de ${S}mm² per a un circuit de ${circuitInfo.name} de ${P}W.`;
            } else {
                maxLength = (conductividad * S * V * maxVoltageDrop) / (2 * P);
                question = `${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()}: Calcula la longitud màxima (en metres) d'una línia monofàsica de ${S}mm² per a un circuit de ${circuitInfo.name} de ${P}W.`;
            }

            return { question, maxLength, isTrifasic, P, S, V, cosPhi, maxVoltageDrop, maxDropPercent, material, conductividad, insulation, isLighting: circuitInfo.isLighting, circuitType: circuitInfo.type, circuitName: circuitInfo.name };
        }
        
        function generateMaxLengthExamples() {
            const container = document.getElementById('max-length-examples-container');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const q = generateMaxLengthQuestion();
                const conductividad = getConductivity(q.material, q.insulation);
                const vDropCalculation = `ΔV = V * (${q.maxDropPercent}% / 100) = ${q.V} * (${q.maxDropPercent} / 100) = ${q.maxVoltageDrop.toFixed(2)} V`;
                const formula = q.isTrifasic
                    ? `L = (γ * S * V * ΔV) / P = (${conductividad} * ${q.S} * ${q.V} * ${q.maxVoltageDrop.toFixed(2)}) / ${q.P} = ${q.maxLength.toFixed(2)} m`
                    : `L = (γ * S * V * ΔV) / (2 * P) = (${conductividad} * ${q.S} * ${q.V} * ${q.maxVoltageDrop.toFixed(2)}) / (2 * ${q.P}) = ${q.maxLength.toFixed(2)} m`;

                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${q.question}</p>
                        <p class="explanation"><strong>${translations[currentLang]['step_1']}:</strong> ${translations[currentLang]['max_voltage_drop_calc']}:</p>
                        <p class="explanation"><span class="formula">${vDropCalculation}</span></p>
                        <p class="explanation"><strong>${translations[currentLang]['step_2']}:</strong> ${translations[currentLang]['max_length_calc']}:</p>
                        <p class="explanation"><span class="formula">${formula}</span></p>
                        <p class="result"><strong>${translations[currentLang]['exercise_resolution']}</strong> ${translations[currentLang]['max_length']}: ${q.maxLength.toFixed(2)} m.</p>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        function generateMaxLengthTest() {
            const container = document.getElementById('max-length-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const { question, maxLength } = generateMaxLengthQuestion();
                currentTestAnswers[`max-length-answer-${i}`] = maxLength;
                const card = `
                    <div class="exercise-card">
                        <p><strong>Cas ${i + 1}:</strong> ${question}</p>
                        <div>Longitud màxima (m): <input type="text" id="max-length-answer-${i}" class="answer-input"></div>
                        <div id="correction-max-length-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
            document.getElementById('max-length-test-error').innerText = "";
        }

        function checkMaxLengthAnswers() {
            let allCorrect = true;
            let filledCount = 0;
            const inputs = document.querySelectorAll('#max-length-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

            if (filledCount < inputs.length) {
                document.getElementById('max-length-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('max-length-test-error').innerText = "";

            for (let i = 0; i < 10; i++) {
                const input = document.getElementById(`max-length-answer-${i}`);
                const correctionDiv = document.getElementById(`correction-max-length-${i}`);
                const userInput = parseFloat(input.value.replace(',', '.'));
                const correctAnswer = currentTestAnswers[input.id];

                if (Math.abs(userInput - correctAnswer) < 1) { // Tolerancia de 1 metro
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    correctionDiv.style.display = 'none';
                } else {
                    allCorrect = false;
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    correctionDiv.innerHTML = `Resultat correcte: <span class="result">${correctAnswer.toFixed(2)} m</span>.`;
                    correctionDiv.style.display = 'block';
                }
            }

            // Recopilar datos del test y enviar informe
            const testData = collectTestData('max-length', 'max-length-test-container', currentTestAnswers, checkMaxLengthAnswers);
            sendTestReportToGoogleSheets('max-length', testData);

            if (allCorrect) {
                saveStudentProgress('maxLengthTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }
        
        // --- Bloque 5: Elecció de Secció per Intensitat (ITC-BT-19) ---
        function generateSectionIntensityQuestion() {
            const material = 'cobre';
            let insulation, method, isTrifasic, conductors, lineType, table, sortedSections;
            let maxAttempts = 100;
            let attempts = 0;
            
            // Buscar una combinación válida
            do {
                insulation = Math.random() > 0.5 ? 'pvc' : 'xlpe';
                method = getRandomFromList(['A1', 'A2', 'B1', 'B2', 'C', 'D', 'E', 'F']);
                isTrifasic = Math.random() > 0.5;
                conductors = isTrifasic ? '3' : '2';
                lineType = isTrifasic ? 'trifàsica' : 'monofàsica';
                
                table = AMPACIDAD_ITC_BT_19[material]?.[insulation]?.[method]?.[conductors];
                if (table) {
                    sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
                }
                attempts++;
            } while ((!table || sortedSections.length === 0) && attempts < maxAttempts);
            
            if (!table || sortedSections.length === 0) {
                // Fallback a una combinación que sabemos que existe
                insulation = 'pvc';
                method = 'B1';
                isTrifasic = true;
                conductors = '3';
                lineType = 'trifàsica';
                table = AMPACIDAD_ITC_BT_19[material][insulation][method][conductors];
                sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
            }
            
            // Generar una intensidad que sea manejable por la tabla
            const maxAmpacity = Math.max(...Object.values(table));
            const minAmpacity = Math.min(...Object.values(table));
            
            // Generar intensidad calculada dentro del rango manejable
            const I_calculated = getRandomInt(Math.max(10, Math.floor(minAmpacity * 0.8)), Math.floor(maxAmpacity * 0.9));
            
            // Paso 1: Encontrar la intensidad normalizada del magnetotérmico
            const I_normalized = NORMALIZED_MAGNETOTERMICOS.find(val => val >= I_calculated) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1];

            // Buscar la primera sección que puede manejar la intensidad normalizada
            // Buscar la primera sección que puede manejar la intensidad normalizada
            let section = null;
            for (const s of sortedSections) {
                if (table[s] >= I_normalized) {
                    section = s;
                    break;
                }
            }
            
            // Si no se encuentra una sección adecuada, regenerar el ejercicio
            if (section === null) {
                return generateSectionIntensityQuestion();
            }

            const methodDesc = {
                'A1': [
                    'Conductors unipolars aïllats en tubs encastats en parets aïllants',
                    'Cables multiconductors encastats directament en parets tèrmicament aïllants',
                    'Conductors unipolars aïllats en motllures',
                    'Conductors unipolars aïllats en conductes o cables uni o multiconductors dins dels marcs de les portes',
                    'Conductors unipolars aïllats en tubs o cables uni o multiconductors dins dels marcs de les finestres'
                ],
                'A2': 'Conductors aïllats en tubs encastats en obra',
                'B1': [
                    'Conductors unipolars aïllats en tubs en muntatge superficial o encastats en obra',
                    'Conductors unipolars aïllats en sobre paret de fusta o separats a una distància inferior a 0,3 vegades el diàmetre del tub',
                    'Conductors unipolars aïllats en conductes de secció no circular sobre paret de fusta',
                    'Conductors unipolars aïllats en conductes encastats en paret d\'obra',
                    'Cables unipolars o multiconductors en buits d\'obra de fàbrica',
                    'Conductors unipolars aïllats en tubs dins de buits d\'obra de fàbrica',
                    'Conductors unipolars aïllats en conductes de secció no circular en buits d\'obra de fàbrica',
                    'Conductors unipolars aïllats o cables unipolars en canal protectora fixades a una paret de fusta o encastades en el sòl',
                    'Cables uni o multiconductors en falsos sostres o sostres suspesos',
                    'Conductors unipolars aïllats en canal protectora suspesa',
                    'Conductors unipolars aïllats en canals d\'obra ventilats',
                    'Cables uni o multiconductors en canals d\'obra ventilats',
                    'Conductors unipolars aïllats o cables unipolars dins de sòcols acanalats'
                ],
                'B2': [
                    'Cables multiconductors en tubs en muntatge superficial o encastats en obra',
                    'Cables multiconductors en tubs sobre paret de fusta o separats a una distància inferior a 0,3 vegades el diàmetre del tub',
                    'Cables multiconductors en conductes de secció no circular sobre paret de fusta',
                    'Cables multiconductors dins de sòcols acanalats'
                ],
                'C': [
                    'Cables multiconductors directament sobre la paret',
                    'Cables unipolars o multiconductors sobre safates no perforades',
                    'Cables unipolars o multiconductors fixats en el sostre o paret de fusta o espaiats 0,3 vegades el diàmetre del cable',
                    'Cables uni o multiconductors encastats directament en parets'
                ],
                'D': 'Cables multiconductors enterrats sota tub',
                'E': [
                    'Cables multiconductors a aire lliure. Distància a la paret no inferior a 0,3 D',
                    'Cables unipolars o multiconductors sobre safates perforades en horitzontal o vertical',
                    'Cables unipolars o multiconductors sobre suports',
                    'Cables unipolars o multiconductors suspesos d\'un cable fiador'
                ],
                'F': [
                    'Cables unipolars en contacte mutu. Distància a la paret no inferior a D',
                    'Cables unipolars o multiconductors sobre safates perforades en horitzontal o vertical',
                    'Cables unipolars o multiconductors sobre suports',
                    'Cables unipolars o multiconductors suspesos d\'un cable fiador'
                ]
            };
            
            const selectedMethodDesc = Array.isArray(methodDesc[method]) 
                ? getRandomFromList(methodDesc[method]) 
                : methodDesc[method];
            
            const question = `${translations[currentLang]['choose_min_section']} ${translations[currentLang]['material_copper']} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()} ${translations[currentLang]['for_line']} ${lineType} ${translations[currentLang]['with_calculated_intensity']} ${I_calculated} ${translations[currentLang]['unit_amperes']}. ${translations[currentLang]['installation_method']} ${selectedMethodDesc}.`;

            return { question, section, I_calculated, I_normalized, material, insulation, method, conductors, lineType, selectedMethodDesc };
        }

        function generateSectionIntensityExamples() {
            const container = document.getElementById('section-intensity-examples-container');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const q = generateSectionIntensityQuestion();
                const table = AMPACIDAD_ITC_BT_19[q.material][q.insulation][q.method][q.conductors];
                
                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${q.question}</p>
                        <p class="explanation"><strong>${translations[currentLang]['step_1']}:</strong> ${translations[currentLang]['normalized_breaker_step']}:</p>
                        <p class="explanation">${translations[currentLang]['calculated_intensity']}: ${q.I_calculated} A → ${translations[currentLang]['normalized_breaker']}: ${q.I_normalized} A</p>
                        <p class="explanation"><strong>${translations[currentLang]['step_2']}:</strong> ${translations[currentLang]['section_selection']}:</p>
                        <p class="explanation">${translations[currentLang]['search_table']} ${translations[currentLang]['material_copper']}, ${q.insulation}, ${translations[currentLang]['method']} ${q.method}, ${translations[currentLang]['line']} ${q.lineType}. ${translations[currentLang]['first_section_supports']} ${q.I_normalized} ${translations[currentLang]['unit_amperes']} ${translations[currentLang]['or_more']} ${q.section} ${translations[currentLang]['unit_mm2']} (${translations[currentLang]['supports_up_to']} ${table[q.section]} ${translations[currentLang]['unit_amperes']}).</p>
                        <p class="result"><strong>${translations[currentLang]['exercise_resolution']}</strong> ${translations[currentLang]['correct_section']} ${q.section} mm².</p>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        function generateSectionIntensityTest() {
            const container = document.getElementById('section-intensity-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const { question, section } = generateSectionIntensityQuestion();
                currentTestAnswers[`section-intensity-answer-${i}`] = section;
                const card = `
                    <div class="exercise-card">
                        <p><strong>Cas ${i + 1}:</strong> ${question}</p>
                        <div>Secció normalitzada (mm²): 
                            <select id="section-intensity-answer-${i}" class="answer-input">
                                ${NORMALIZED_SECTIONS.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        <div id="correction-section-intensity-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
            document.getElementById('section-intensity-test-error').innerText = "";
        }

        function checkSectionIntensityAnswers() {
            let allCorrect = true;
            let filledCount = 0;
            const inputs = document.querySelectorAll('#section-intensity-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

             if (filledCount < inputs.length) {
                document.getElementById('section-intensity-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('section-intensity-test-error').innerText = "";

            for (let i = 0; i < 10; i++) {
                const input = document.getElementById(`section-intensity-answer-${i}`);
                const correctionDiv = document.getElementById(`correction-section-intensity-${i}`);
                const userInput = parseFloat(input.value);
                const correctAnswer = currentTestAnswers[input.id];

                if (userInput === correctAnswer) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    correctionDiv.style.display = 'none';
                } else {
                    allCorrect = false;
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    correctionDiv.innerHTML = `Resultat correcte: <span class="result">${correctAnswer} mm²</span>.`;
                    correctionDiv.style.display = 'block';
                }
            }

            // Recopilar datos del test y enviar informe
            const testData = collectTestData('section-intensity', 'section-intensity-test-container', currentTestAnswers, checkSectionIntensityAnswers);
            sendTestReportToGoogleSheets('section-intensity', testData);

            if (allCorrect) {
                saveStudentProgress('sectionIntensityTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }

        // --- Bloque 6: Cálculo de Sección (Intensitat i ΔV) ---
        function generateSectionBothQuestion() {
            // Generar datos para cálculo de intensidad
            const intensityData = generateIntensityQuestion();
            const I = intensityData.answer;

            // Generar datos para elegir sección por intensidad
            const sectionIntensityData = generateSectionIntensityQuestion();
            const sectionForIntensity = getSectionByIntensity(I, intensityData.material, sectionIntensityData.insulation, sectionIntensityData.method, sectionIntensityData.conductors);
            
            // Generar datos para cálculo de sección por ΔV
            const sectionVoltageDropData = generateSectionQuestion();
            sectionVoltageDropData.P = intensityData.P; // Usar la misma potencia
            sectionVoltageDropData.material = intensityData.material; // Usar el mismo material
            sectionVoltageDropData.insulation = intensityData.insulation; // Usar el mismo aislamiento
            const sectionForVoltageDrop = sectionVoltageDropData.normalizedSection;

            // Comparar i elegir la mayor
            const finalSection = Math.max(sectionForIntensity, sectionForVoltageDrop);
            
            // Apply minimum section restrictions based on circuit type
            const circuitType = sectionVoltageDropData.circuitType;
            const material = intensityData.material;
            const finalNormalizedSection = applyMinimumSection(finalSection, circuitType, material);

            // Get material text for question
            const materialText = material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
            
            const question = `${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${intensityData.insulation.toUpperCase()}: Calcula la secció final per a un circuit de ${sectionVoltageDropData.circuitName} amb una línia ${intensityData.isTrifasic ? 'trifàsica' : 'monofàsica'} de ${sectionVoltageDropData.L} m que alimenta un receptor de ${intensityData.P} W amb cos(φ) = ${intensityData.cosPhi}. ${translations[currentLang]['installation_system']} ${getInstallationDescription(sectionIntensityData.method)}.`;

            return {
                question,
                I,
                sectionForIntensity,
                calculatedSectionForVoltageDrop: sectionVoltageDropData.calculatedSection,
                sectionForVoltageDrop,
                finalSection,
                finalNormalizedSection,
                circuitType,
                circuitName: sectionVoltageDropData.circuitName,
                material: material,
                insulation: intensityData.insulation,
                method: sectionIntensityData.method,
                L: sectionVoltageDropData.L,
                P: intensityData.P,
                cosPhi: intensityData.cosPhi,
                isTrifasic: intensityData.isTrifasic
            };
        }
        
        function getSectionByIntensity(intensity, material = 'cobre', insulation = 'pvc', method = 'B1', conductors = '3') {
            const table = AMPACIDAD_ITC_BT_19[material]?.[insulation]?.[method]?.[conductors];
            if (!table) return NORMALIZED_SECTIONS[NORMALIZED_SECTIONS.length - 1]; // Fallback

            const sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
            for (const s of sortedSections) {
                if (table[s] >= intensity) {
                    return s;
                }
            }
            return sortedSections[sortedSections.length - 1];
        }

        function generateSectionBothExamples() {
            const container = document.getElementById('section-both-examples-container');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const q = generateSectionBothQuestion();
                
                // Calculate intensity formula
                const intensityFormula = q.isTrifasic 
                    ? `I = P / (V * √3 * cos(φ)) = ${q.P} / (${q.isTrifasic ? V_TRIFASICA : V_MONOFASICA} * 1.732 * ${q.cosPhi}) = ${q.I.toFixed(2)} A`
                    : `I = P / (V * cos(φ)) = ${q.P} / (${q.isTrifasic ? V_TRIFASICA : V_MONOFASICA} * ${q.cosPhi}) = ${q.I.toFixed(2)} A`;
                
                // Calculate section for voltage drop formula
                const conductividad = getConductivity(q.material, q.insulation);
                const maxVoltageDrop = (q.isTrifasic ? V_TRIFASICA : V_MONOFASICA) * (3 / 100); // Using 3% as example
                const sectionVoltageDropFormula = q.isTrifasic
                    ? `S = (P * L) / (γ * V * ΔV) = (${q.P} * ${q.L}) / (${conductividad} * ${q.isTrifasic ? V_TRIFASICA : V_MONOFASICA} * ${maxVoltageDrop.toFixed(2)}) = ${q.calculatedSectionForVoltageDrop.toFixed(2)} mm²`
                    : `S = (2 * P * L) / (γ * V * ΔV) = (2 * ${q.P} * ${q.L}) / (${conductividad} * ${q.isTrifasic ? V_TRIFASICA : V_MONOFASICA} * ${maxVoltageDrop.toFixed(2)}) = ${q.calculatedSectionForVoltageDrop.toFixed(2)} mm²`;
                
                const materialText = q.material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
                
                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${q.question}</p>
                        <p><strong>${translations[currentLang]['exercise_resolution']}:</strong></p>
                        <ul>
                            <li><strong>1. ${translations[currentLang]['calc_section_by_intensity']}</strong>
                                <ul>
                                    <li>${translations[currentLang]['calculated_intensity']}: <span class="formula">${intensityFormula}</span></li>
                                    <li>${translations[currentLang]['normalized_breaker']}: ${NORMALIZED_MAGNETOTERMICOS.find(val => val >= q.I) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1]} A</li>
                                    <li>${translations[currentLang]['section_selection']}: ${q.sectionForIntensity} mm² (${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${q.insulation.toUpperCase()}, ${translations[currentLang]['method']} ${q.method}: ${getInstallationDescription(q.method)})</li>
                                </ul>
                            </li>
                            <li><strong>2. ${translations[currentLang]['calc_max_length_voltage_drop']}</strong>
                                <ul>
                                    <li>${translations[currentLang]['section_calc']}: <span class="formula">${sectionVoltageDropFormula}</span></li>
                                    <li>${translations[currentLang]['normalized_section']}: ${q.sectionForVoltageDrop} mm²</li>
                                </ul>
                            </li>
                            <li><strong>3. ${translations[currentLang]['conclusion']}:</strong>
                                <ul>
                                    <li>${translations[currentLang]['choose_larger_section']} ${q.sectionForIntensity} mm² ${translations[currentLang]['and']} ${q.sectionForVoltageDrop} mm².</li>
                                    ${q.circuitType.startsWith('individual_') || q.circuitType.startsWith('lga_') ? 
                                        `<li>${translations[currentLang]['min_regulatory_section']}: ${getMinimumSection(q.circuitType, q.material)} mm² ${q.circuitType.startsWith('individual_') ? translations[currentLang]['individual_derivation'] : q.material === 'aluminio' ? translations[currentLang]['lga_aluminum'] : translations[currentLang]['lga_copper']}.</li>` : ''}
                                    <li class="result optimal-result">${translations[currentLang]['final_correct_section']} ${q.finalNormalizedSection} mm².</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        function generateSectionBothTest() {
            const container = document.getElementById('section-both-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const q = generateSectionBothQuestion();
                currentTestAnswers[`section-both-answer-${i}`] = q.finalNormalizedSection;
                const card = `
                    <div class="exercise-card">
                        <p><strong>Cas ${i + 1}:</strong> ${q.question}</p>
                        <div>
                            Secció final (mm²): 
                            <select id="section-both-answer-${i}" class="answer-input">
                                ${NORMALIZED_SECTIONS.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                        <div id="correction-section-both-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
             document.getElementById('section-both-test-error').innerText = "";
        }

        function checkSectionBothAnswers() {
            let allCorrect = true;
            let filledCount = 0;
            const inputs = document.querySelectorAll('#section-both-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

             if (filledCount < inputs.length) {
                document.getElementById('section-both-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('section-both-test-error').innerText = "";


            for (let i = 0; i < 10; i++) {
                const input = document.getElementById(`section-both-answer-${i}`);
                const correctionDiv = document.getElementById(`correction-section-both-${i}`);
                const userInput = parseFloat(input.value);
                const correctAnswer = currentTestAnswers[input.id];

                if (userInput === correctAnswer) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                    correctionDiv.style.display = 'none';
                } else {
                    allCorrect = false;
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    correctionDiv.innerHTML = `Resultat correcte: <span class="result">${correctAnswer} mm²</span>.`;
                    correctionDiv.style.display = 'block';
                }
            }

            // Recopilar datos del test y enviar informe
            const testData = collectTestData('section-both', 'section-both-test-container', currentTestAnswers, checkSectionBothAnswers);
            sendTestReportToGoogleSheets('section-both', testData);

            if (allCorrect) {
                 saveStudentProgress('sectionBothTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }
        
         // --- Bloque 7: Cálculo de Longitud Máxima (Intensitat i ΔV) ---
        function generateMaxLengthBothQuestion() {
            // 1. Generar datos para cálculo de intensidad
            const intensityData = generateIntensityQuestion();
            const I = intensityData.answer;
            
            // 2 out of 10 exercises should use aluminum
            const material = Math.random() < 0.2 ? 'aluminio' : 'cobre';
            const materialText = material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];

            // Add insulation information
            const insulation = Math.random() > 0.5 ? 'pvc' : 'xlpe';
            const conductividad = getConductivity(material, insulation);

            // 2. Generar datos para la tabla ITC-BT-19 (sin usar generateSectionIntensityQuestion)
            let method, conductors, lineType, table, sortedSections;
            let maxAttempts = 100;
            let attempts = 0;
            
            // Buscar una combinación válida en la tabla
            do {
                method = getRandomFromList(['A1', 'A2', 'B1', 'B2', 'C', 'D', 'E', 'F']);
                conductors = intensityData.isTrifasic ? '3' : '2';
                lineType = intensityData.isTrifasic ? 'trifàsica' : 'monofàsica';
                
                table = AMPACIDAD_ITC_BT_19[material]?.[insulation]?.[method]?.[conductors];
                if (table) {
                    sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
                }
                attempts++;
            } while ((!table || sortedSections.length === 0) && attempts < maxAttempts);

            // Calcular la intensidad normalizada del magnetotérmico
            const I_normalized = NORMALIZED_MAGNETOTERMICOS.find(val => val >= I) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1];
            
            // Encontrar la sección mínima que soporte la intensidad normalizada
            let section = getSectionByIntensity(I_normalized, material, insulation, method, conductors);
            
            // 3. Generar datos para cálculo de longitud máxima
            const circuitInfo = getCircuitTypeAndDrop(!intensityData.isTrifasic); // Pass isMonophasic parameter
            
            // Apply minimum section restrictions
            section = Math.max(section, getMinimumSection(circuitInfo.type, material));
            const finalSection = NORMALIZED_SECTIONS.find(s => s >= section) || NORMALIZED_SECTIONS[NORMALIZED_SECTIONS.length - 1];
            
            const maxDropPercent = circuitInfo.maxDropPercent;
            const maxVoltageDrop = intensityData.V * (maxDropPercent / 100);
            
            // Recalcular la longitud màxima amb la nova secció
            let finalMaxLength;
            if (intensityData.isTrifasic) {
                 finalMaxLength = (conductividad * finalSection * intensityData.V * maxVoltageDrop) / intensityData.P;
            } else {
                 finalMaxLength = (conductividad * finalSection * intensityData.V * maxVoltageDrop) / (2 * intensityData.P);
            }

            const question = `${translations[currentLang]['with_conductor']} ${materialText} ${translations[currentLang]['with_insulation']} ${insulation.toUpperCase()}: Calcula la longitud màxima ${translations[currentLang]['circuit_type']} ${circuitInfo.name} amb una línia ${intensityData.isTrifasic ? 'trifàsica' : 'monofàsica'} que alimenta un receptor de ${intensityData.P} W. ${translations[currentLang]['installation_system']} ${getInstallationDescription(method)}.`;

            return { 
                question, 
                I, 
                section: finalSection, 
                finalMaxLength,
                // Additional data for detailed calculations
                P: intensityData.P,
                V: intensityData.V,
                cosPhi: intensityData.cosPhi,
                isTrifasic: intensityData.isTrifasic,
                I_normalized: I_normalized,
                insulation: insulation,
                method: method,
                conductors: conductors,
                maxDropPercent: circuitInfo.maxDropPercent,
                maxVoltageDrop: maxVoltageDrop,
                material: material,
                conductividad: conductividad,
                circuitType: circuitInfo.type,
                circuitName: circuitInfo.name
            };
        }
        
        function generateMaxLengthBothExamples() {
            const container = document.getElementById('max-length-both-examples-container');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const q = generateMaxLengthBothQuestion();
                const table = AMPACIDAD_ITC_BT_19[q.material][q.insulation][q.method][q.conductors];
                
                // Calculate intensity formula
                const intensityFormula = q.isTrifasic 
                    ? `I = P / (V * √3 * cos(φ)) = ${q.P} / (${q.V} * 1.732 * ${q.cosPhi}) = ${q.I.toFixed(2)} A`
                    : `I = P / (V * cos(φ)) = ${q.P} / (${q.V} * ${q.cosPhi}) = ${q.I.toFixed(2)} A`;
                
                // Calculate max length formula with correct conductivity
                const maxLengthFormula = q.isTrifasic
                    ? `L = (γ * S * V * ΔV) / P = (${q.conductividad} * ${q.section} * ${q.V} * ${q.maxVoltageDrop.toFixed(2)}) / ${q.P} = ${q.finalMaxLength.toFixed(2)} m`
                    : `L = (γ * S * V * ΔV) / (2 * P) = (${q.conductividad} * ${q.section} * ${q.V} * ${q.maxVoltageDrop.toFixed(2)}) / (2 * ${q.P}) = ${q.finalMaxLength.toFixed(2)} m`;
                
                const materialText = q.material === 'aluminio' ? translations[currentLang]['material_aluminum'] : translations[currentLang]['material_copper'];
                
                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_question']}</strong> ${q.question}</p>
                        <p class="explanation"><strong>${translations[currentLang]['exercise_step']} 1:</strong> ${translations[currentLang]['calc_section_by_intensity']}</p>
                        <p class="explanation">1.1. ${translations[currentLang]['intensity_calc']}:</p>
                        <p class="explanation"><span class="formula">${intensityFormula}</span></p>
                        <p class="explanation">1.2. ${translations[currentLang]['normalized_breaker']}:</p>
                        <p class="explanation">${translations[currentLang]['calculated_intensity']}: ${q.I.toFixed(2)} ${translations[currentLang]['unit_amperes']} → ${translations[currentLang]['normalized_breaker']}: ${q.I_normalized} ${translations[currentLang]['unit_amperes']}</p>
                        <p class="explanation">1.3. ${translations[currentLang]['section_selection']}:</p>
                        <p class="explanation">${translations[currentLang]['search_table']} ${materialText}, ${q.insulation}, ${translations[currentLang]['method']} ${q.method}, ${translations[currentLang]['line']} ${q.isTrifasic ? translations[currentLang]['trifasic'] : translations[currentLang]['monofasic']}. ${translations[currentLang]['first_section_supports']} ${q.I_normalized} ${translations[currentLang]['unit_amperes']} ${translations[currentLang]['or_more']} ${q.section} ${translations[currentLang]['unit_mm2']} (${translations[currentLang]['supports_up_to']} ${table[q.section]} ${translations[currentLang]['unit_amperes']}).</p>
                        <p class="explanation"><strong>${translations[currentLang]['exercise_step']} 2:</strong> ${translations[currentLang]['calc_max_length_voltage_drop']}</p>
                        <p class="explanation">2.1. ${translations[currentLang]['max_voltage_drop_calc']}:</p>
                        <p class="explanation"><span class="formula">ΔV = V * (${q.maxDropPercent}% / 100) = ${q.V} * (${q.maxDropPercent} / 100) = ${q.maxVoltageDrop.toFixed(2)} V</span></p>
                        <p class="explanation">2.2. ${translations[currentLang]['max_length_calc']}:</p>
                        <p class="explanation"><span class="formula">${maxLengthFormula}</span></p>
                        <p class="result"><strong>${translations[currentLang]['exercise_resolution']}</strong> ${translations[currentLang]['max_length']}: ${q.finalMaxLength.toFixed(2)} ${translations[currentLang]['unit_meters']}.</p>
                    </div>
                `;
                container.innerHTML += card;
            }
        }
        
        function generateMaxLengthBothTest() {
            const container = document.getElementById('max-length-both-test-container');
            container.innerHTML = '';
            currentTestAnswers = {};
            for (let i = 0; i < 10; i++) {
                const q = generateMaxLengthBothQuestion();
                currentTestAnswers[`max-length-both-answer-${i}`] = q.finalMaxLength;
                const card = `
                    <div class="exercise-card">
                        <p><strong>${translations[currentLang]['exercise_case']} ${i + 1}:</strong> ${q.question}</p>
                        <div>${translations[currentLang]['input_max_length']} (${translations[currentLang]['unit_meters']}): <input type="text" id="max-length-both-answer-${i}" class="answer-input"></div>
                        <div id="correction-max-length-both-${i}" class="correction-result" style="display:none;"></div>
                    </div>
                `;
                container.innerHTML += card;
            }
            document.getElementById('max-length-both-test-error').innerText = "";
        }

        function checkMaxLengthBothAnswers() {
            let allCorrect = true;
            let filledCount = 0;
            const inputs = document.querySelectorAll('#max-length-both-test-container .answer-input');
            
            inputs.forEach(input => {
                if(input.value.trim() !== "") filledCount++;
            });

            if (filledCount < inputs.length) {
                document.getElementById('max-length-both-test-error').innerText = translations[currentLang]['error_complete_all'];
                return;
            }
            document.getElementById('max-length-both-test-error').innerText = "";

            for (let i = 0; i < 10; i++) {
                const input = document.getElementById(`max-length-both-answer-${i}`);
                const correctionDiv = document.getElementById(`correction-max-length-both-${i}`);
                const userInput = parseFloat(input.value.replace(',', '.'));
                const correctAnswer = currentTestAnswers[input.id];

                if (Math.abs(userInput - correctAnswer) < 1) { // Tolerancia de 1 metro
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                     correctionDiv.style.display = 'none';
                } else {
                    allCorrect = false;
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    correctionDiv.innerHTML = `${translations[currentLang]['correct_result']}: <span class="result">${correctAnswer.toFixed(2)} ${translations[currentLang]['unit_meters']}</span>.`;
                    correctionDiv.style.display = 'block';
                }
            }

            // Recopilar datos del test y enviar informe
            const testData = collectTestData('max-length-both', 'max-length-both-test-container', currentTestAnswers, checkMaxLengthBothAnswers);
            sendTestReportToGoogleSheets('max-length-both', testData);

            if (allCorrect) {
                saveStudentProgress('maxLengthBothTest');
                setTimeout(() => showPage('final-page'), 1000);
            }
        }


        // ===================== RENDERIZADO DE INFORMES =====================
        function renderProgressReport() {
            const progress = JSON.parse(localStorage.getItem('studentProgress')) || {};
            const tableBody = document.getElementById('report-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            Object.values(progress).forEach(studentProgress => {
                const row = document.createElement('tr');
                const statusClass = (status) => status === 'Superat' ? 'status-passed' : 'status-pending';

                row.innerHTML = `
                    <td>${studentProgress.name}</td>
                    <td>${studentProgress.email}</td>
                    <td class="${statusClass(studentProgress.intensityTest)}">${studentProgress.intensityTest}</td>
                    <td class="${statusClass(studentProgress.sectionTest)}">${studentProgress.sectionTest}</td>
                    <td class="${statusClass(studentProgress.voltageDropTest)}">${studentProgress.voltageDropTest}</td>
                    <td class="${statusClass(studentProgress.maxLengthTest)}">${studentProgress.maxLengthTest}</td>
                    <td class="${statusClass(studentProgress.sectionIntensityTest)}">${studentProgress.sectionIntensityTest}</td>
                    <td class="${statusClass(studentProgress.sectionBothTest)}">${studentProgress.sectionBothTest}</td>
                    <td class="${statusClass(studentProgress.maxLengthBothTest)}">${studentProgress.maxLengthBothTest}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Guided Exercise Functions
        let guidedExercises = {
            intensity: { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] },
            section: { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] },
            'voltage-drop': { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] },
            'max-length': { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] },
            'section-intensity': { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] },
            'section-both': { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] },
            'max-length-both': { currentStep: 0, totalSteps: 0, currentExercise: null, steps: [] }
        };

        function generateNewGuidedExercise(type) {
            const exercise = guidedExercises[type];
            exercise.currentStep = 0;
            
            // Reset attempts and results
            exercise.stepAttempts = [];
            exercise.stepResults = [];
            
            switch(type) {
                case 'intensity':
                    generateIntensityGuidedExercise();
                    break;
                case 'section':
                    generateSectionGuidedExercise();
                    break;
                case 'voltage-drop':
                    generateVoltageDropGuidedExercise();
                    break;
                case 'max-length':
                    generateMaxLengthGuidedExercise();
                    break;
                case 'section-intensity':
                    generateSectionIntensityGuidedExercise();
                    break;
                case 'section-both':
                    generateSectionBothGuidedExercise();
                    break;
                case 'max-length-both':
                    generateMaxLengthBothGuidedExercise();
                    break;
            }
            
            updateGuidedExerciseDisplay(type);
        }

        function nextGuidedStep(type) {
            const exercise = guidedExercises[type];
            if (exercise.currentStep < exercise.totalSteps - 1) {
                exercise.currentStep++;
                updateGuidedExerciseDisplay(type);
            }
        }

        function previousGuidedStep(type) {
            const exercise = guidedExercises[type];
            if (exercise.currentStep > 0) {
                exercise.currentStep--;
                updateGuidedExerciseDisplay(type);
            }
        }

        function updateGuidedExerciseDisplay(type) {
            const exercise = guidedExercises[type];
            const content = document.getElementById(`${type}-guided-content`);
            const prevBtn = document.getElementById(`${type}-prev-step`);
            const nextBtn = document.getElementById(`${type}-next-step`);
            const newExerciseBtn = document.getElementById(`${type}-new-exercise`);

            if (exercise.steps.length > 0) {
                content.innerHTML = exercise.steps[exercise.currentStep];
                
                prevBtn.style.display = exercise.currentStep > 0 ? 'inline-block' : 'none';
                nextBtn.style.display = exercise.currentStep < exercise.totalSteps - 1 ? 'inline-block' : 'none';
                newExerciseBtn.style.display = exercise.currentStep === exercise.totalSteps - 1 ? 'inline-block' : 'none';
                
                // Check if current step has inputs that need to be completed
                const hasInput = content.querySelector('.guided-input');
                if (hasInput && exercise.currentStep > 1) { // Steps with inputs (step 3 and beyond)
                    nextBtn.style.opacity = '0.5';
                    nextBtn.disabled = true;
                } else {
                    nextBtn.style.opacity = '1';
                    nextBtn.disabled = false;
                }
            }
        }

        function checkGuidedStep(type, step, correctAnswer) {
            const exercise = guidedExercises[type];
            const input = document.getElementById(`${type}-step${step}-input`);
            const feedback = document.getElementById(`${type}-step${step}-feedback`);
            const result = document.getElementById(`${type}-step${step}-result`);
            
            if (!input || !feedback) return;
            
            const userAnswer = parseFloat(input.value.replace(',', '.'));
            const tolerance = correctAnswer > 100 ? correctAnswer * 0.02 : 0.1; // 2% tolerance for large numbers, 0.1 for small
            
            // Initialize attempts if not exists
            if (!exercise.stepAttempts) exercise.stepAttempts = [];
            if (!exercise.stepAttempts[step]) exercise.stepAttempts[step] = 0;
            
            exercise.stepAttempts[step]++;
            
            const isCorrect = Math.abs(userAnswer - correctAnswer) <= tolerance;
            
            if (isCorrect) {
                feedback.innerHTML = `<span class="correct-feedback">✓ ${translations[currentLang].correct_answer}</span>`;
                feedback.className = 'feedback correct';
                input.disabled = true;
                input.nextElementSibling.disabled = true; // Disable button
                if (result) result.style.display = 'block';
                
                // Enable next step button after a short delay
                setTimeout(() => {
                    const nextBtn = document.getElementById(`${type}-next-step`);
                    if (nextBtn && nextBtn.style.display !== 'none') {
                        nextBtn.style.opacity = '1';
                        nextBtn.disabled = false;
                    }
                }, 500);
                
            } else if (exercise.stepAttempts[step] >= 2) {
                // After 2 failed attempts, show correct answer
                feedback.innerHTML = `<span class="wrong-feedback">✗ ${translations[currentLang].incorrect_answer}. ${translations[currentLang].correct_answer_is}: <strong>${correctAnswer}</strong></span>`;
                feedback.className = 'feedback wrong';
                input.disabled = true;
                input.nextElementSibling.disabled = true; // Disable button
                if (result) result.style.display = 'block';
                
                // Enable next step button
                setTimeout(() => {
                    const nextBtn = document.getElementById(`${type}-next-step`);
                    if (nextBtn && nextBtn.style.display !== 'none') {
                        nextBtn.style.opacity = '1';
                        nextBtn.disabled = false;
                    }
                }, 500);
                
            } else {
                // First incorrect attempt
                feedback.innerHTML = `<span class="wrong-feedback">✗ ${translations[currentLang].incorrect_answer} (${translations[currentLang].attempt_of} ${exercise.stepAttempts[step]} ${translations[currentLang].of} 2)</span>`;
                feedback.className = 'feedback wrong';
                input.value = '';
                input.focus();
            }
        }

        function generateIntensityGuidedExercise() {
            const P = getRandomValue([1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 6000, 8000, 10000]);
            const V = getRandomValue([230, 400]);
            const cosφ = getRandomValue([0.8, 0.85, 0.9, 0.95, 1]);
            
            const I = P / (V * cosφ);
            const exercise = guidedExercises.intensity;
            
            exercise.currentExercise = { P, V, cosφ, I };
            exercise.stepAttempts = [0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].power}: ${P} W</p>
                    <p>${translations[currentLang].voltage}: ${V} V</p>
                    <p>${translations[currentLang].cosine}: ${cosφ}</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].intensity}</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].formula}</h3>
                    <p><strong>${translations[currentLang].formula_to_use}:</strong></p>
                    <p>I = P / (V × cos φ)</p>
                    <p><strong>${translations[currentLang].where}:</strong></p>
                    <ul>
                        <li>I = ${translations[currentLang].intensity} (A)</li>
                        <li>P = ${translations[currentLang].power} (W)</li>
                        <li>V = ${translations[currentLang].voltage} (V)</li>
                        <li>cos φ = ${translations[currentLang].cosine}</li>
                    </ul>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].substitution}</h3>
                    <p><strong>${translations[currentLang].substitute_values}:</strong></p>
                    <p>I = ${P} / (${V} × ${cosφ})</p>
                    <p><strong>${translations[currentLang].calculate_denominator} (V × cos φ):</strong></p>
                    <div class="input-group">
                        <input type="text" id="intensity-step3-input" placeholder="${translations[currentLang].introduce_result}" class="guided-input">
                        <button onclick="checkGuidedStep('intensity', 3, ${(V * cosφ).toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="intensity-step3-feedback" class="feedback"></div>
                    <div id="intensity-step3-result" class="step-result" style="display:none;">
                        <p>V × cos φ = ${V} × ${cosφ} = ${(V * cosφ).toFixed(2)}</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].final_calculation}:</strong></p>
                    <p>I = ${P} / ${(V * cosφ).toFixed(2)}</p>
                    <p><strong>${translations[currentLang].calculate} ${translations[currentLang].intensity}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="intensity-step4-input" placeholder="${translations[currentLang].introduce_result_amperes}" class="guided-input">
                        <button onclick="checkGuidedStep('intensity', 4, ${I.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="intensity-step4-feedback" class="feedback"></div>
                    <div id="intensity-step4-result" class="step-result" style="display:none;">
                        <div class="solution">
                            <strong>${translations[currentLang].answer}: ${I.toFixed(2)} A</strong>
                        </div>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        function generateSectionGuidedExercise() {
            const I = getRandomValue([10, 15, 20, 25, 30, 35, 40, 50, 60, 80, 100]);
            const L = getRandomValue([10, 15, 20, 25, 30, 50, 80, 100, 150, 200]);
            const ΔV_percent = getRandomValue([3, 5]);
            const V = getRandomValue([230, 400]);
            
            const ΔV = V * ΔV_percent / 100;
            const ρ = 0.0175;
            const S = (2 * ρ * I * L) / ΔV;
            const selectedSection = sections.find(s => s >= S) || sections[sections.length - 1];
            
            const exercise = guidedExercises.section;
            exercise.currentExercise = { I, L, ΔV_percent, V, ΔV, S, selectedSection };
            exercise.stepAttempts = [0, 0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].intensity}: ${I} A</p>
                    <p>${translations[currentLang].length}: ${L} m</p>
                    <p>${translations[currentLang].voltage}: ${V} V</p>
                    <p>${translations[currentLang].max_voltage_drop}: ${ΔV_percent}%</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].section}</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].formula}</h3>
                    <p><strong>${translations[currentLang].formula_to_use}:</strong></p>
                    <p>S = (2 × ρ × I × L) / ΔV</p>
                    <p><strong>${translations[currentLang].where}:</strong></p>
                    <ul>
                        <li>S = ${translations[currentLang].section} (mm²)</li>
                        <li>ρ = ${translations[currentLang].resistivity} (0.0175 Ω·mm²/m)</li>
                        <li>I = ${translations[currentLang].intensity} (A)</li>
                        <li>L = ${translations[currentLang].length} (m)</li>
                        <li>ΔV = ${translations[currentLang].voltage_drop} (V)</li>
                    </ul>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].calculate} ΔV</h3>
                    <p><strong>${translations[currentLang].calculate_voltage_drop}:</strong></p>
                    <p>ΔV = ${V} × ${ΔV_percent}% / 100</p>
                    <p><strong>Calcula la caída de tensión en voltios:</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-step3-input" placeholder="Introduce el resultado en V" class="guided-input">
                        <button onclick="checkGuidedStep('section', 3, ${ΔV.toFixed(2)})" class="check-btn">Verificar</button>
                    </div>
                    <div id="section-step3-feedback" class="feedback"></div>
                    <div id="section-step3-result" class="step-result" style="display:none;">
                        <p>ΔV = ${V} × ${ΔV_percent} / 100 = ${ΔV.toFixed(2)} V</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].substitution}</h3>
                    <p><strong>${translations[currentLang].substitute_values}:</strong></p>
                    <p>S = (2 × 0.0175 × ${I} × ${L}) / ${ΔV.toFixed(2)}</p>
                    <p><strong>${translations[currentLang].calculate} (2 × ρ × I × L):</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-step4-input" placeholder="${translations[currentLang].introduce_result}" class="guided-input">
                        <button onclick="checkGuidedStep('section', 4, ${(2 * ρ * I * L).toFixed(3)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-step4-feedback" class="feedback"></div>
                    <div id="section-step4-result" class="step-result" style="display:none;">
                        <p>2 × 0.0175 × ${I} × ${L} = ${(2 * ρ * I * L).toFixed(3)}</p>
                        <p>S = ${(2 * ρ * I * L).toFixed(3)} / ${ΔV.toFixed(2)} = ${S.toFixed(2)} mm²</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 5: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].select_commercial_section}:</strong></p>
                    <p>${translations[currentLang].calculated_section}: ${S.toFixed(2)} mm²</p>
                    <p>${translations[currentLang].available_sections}: ${sections.join(', ')} mm²</p>
                    <p><strong>${translations[currentLang].select_commercial_section}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-step5-input" placeholder="${translations[currentLang].introduce_section_mm2}" class="guided-input">
                        <button onclick="checkGuidedStep('section', 5, ${selectedSection})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-step5-feedback" class="feedback"></div>
                    <div id="section-step5-result" class="step-result" style="display:none;">
                        <div class="solution">
                            <strong>${translations[currentLang].answer}: ${selectedSection} mm²</strong>
                        </div>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        // Add more guided exercise generators for other types (voltage-drop, max-length, etc.)
        function generateVoltageDropGuidedExercise() {
            const I = getRandomValue([10, 15, 20, 25, 30, 35, 40, 50, 60]);
            const L = getRandomValue([10, 20, 30, 50, 80, 100, 150, 200]);
            const S = getRandomValue(sections);
            const V = getRandomValue([230, 400]);
            
            const ρ = 0.0175;
            const ΔV = (2 * ρ * I * L) / S;
            const ΔV_percent = (ΔV / V) * 100;
            
            const exercise = guidedExercises['voltage-drop'];
            exercise.currentExercise = { I, L, S, V };
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].intensity}: ${I} A</p>
                    <p>${translations[currentLang].length}: ${L} m</p>
                    <p>${translations[currentLang].section}: ${S} mm²</p>
                    <p>${translations[currentLang].voltage}: ${V} V</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].voltage_drop}</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].formula}</h3>
                    <p><strong>${translations[currentLang].formula_to_use}:</strong></p>
                    <p>ΔV = (2 × ρ × I × L) / S</p>
                    <p><strong>${translations[currentLang].where}:</strong></p>
                    <ul>
                        <li>ΔV = ${translations[currentLang].voltage_drop} (V)</li>
                        <li>ρ = ${translations[currentLang].resistivity} (0.0175 Ω·mm²/m)</li>
                        <li>I = ${translations[currentLang].intensity} (A)</li>
                        <li>L = ${translations[currentLang].length} (m)</li>
                        <li>S = ${translations[currentLang].section} (mm²)</li>
                    </ul>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].substitution}</h3>
                    <p><strong>${translations[currentLang].substitute_values}:</strong></p>
                    <p>ΔV = (2 × 0.0175 × ${I} × ${L}) / ${S}</p>
                    <p>ΔV = ${(2 * ρ * I * L).toFixed(3)} / ${S}</p>
                    <p>ΔV = ${ΔV.toFixed(2)} V</p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].percentage_calculation}:</strong></p>
                    <p>ΔV% = (${ΔV.toFixed(2)} / ${V}) × 100 = ${ΔV_percent.toFixed(2)}%</p>
                    <div class="solution">
                        <strong>${translations[currentLang].answer}: ${ΔV.toFixed(2)} V (${ΔV_percent.toFixed(2)}%)</strong>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        function generateVoltageDropGuidedExercise() {
            const P = getRandomValue([2000, 3000, 4000, 5000, 6000, 8000, 10000]);
            const L = getRandomValue([20, 30, 50, 80, 100, 150]);
            const S = getRandomValue([2.5, 4, 6, 10, 16, 25]);
            const V = getRandomValue([230, 400]);
            const isTrifasic = V === 400;
            const material = 'cobre';
            const insulation = 'pvc';
            const conductivity = getConductivity(material, insulation);
            
            let voltageDrop, voltageDropPercent;
            if (isTrifasic) {
                voltageDrop = (P * L) / (conductivity * S * V);
            } else {
                voltageDrop = (2 * P * L) / (conductivity * S * V);
            }
            voltageDropPercent = (voltageDrop / V) * 100;
            
            const exercise = guidedExercises['voltage-drop'];
            exercise.currentExercise = { P, L, S, V, isTrifasic, voltageDrop, voltageDropPercent, conductivity };
            exercise.stepAttempts = [0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].power}: ${P} W</p>
                    <p>${translations[currentLang].length}: ${L} m</p>
                    <p>${translations[currentLang].section}: ${S} mm²</p>
                    <p>${translations[currentLang].voltage}: ${V} V (${isTrifasic ? translations[currentLang].trifasic : translations[currentLang].monofasic})</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].voltage_drop}</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].formula}</h3>
                    <p><strong>${translations[currentLang].formula_to_use}:</strong></p>
                    <p>${isTrifasic ? 'ΔV = (P × L) / (γ × S × V)' : 'ΔV = (2 × P × L) / (γ × S × V)'}</p>
                    <p><strong>${translations[currentLang].where}:</strong></p>
                    <ul>
                        <li>ΔV = ${translations[currentLang].voltage_drop} (V)</li>
                        <li>P = ${translations[currentLang].power} (W)</li>
                        <li>L = ${translations[currentLang].length} (m)</li>
                        <li>γ = ${translations[currentLang].resistivity} (${conductivity} m/Ω·mm²)</li>
                        <li>S = ${translations[currentLang].section} (mm²)</li>
                        <li>V = ${translations[currentLang].voltage} (V)</li>
                    </ul>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].substitution}</h3>
                    <p><strong>${translations[currentLang].substitute_values}:</strong></p>
                    <p>ΔV = ${isTrifasic ? `(${P} × ${L}) / (${conductivity} × ${S} × ${V})` : `(2 × ${P} × ${L}) / (${conductivity} × ${S} × ${V})`}</p>
                    <p><strong>${translations[currentLang].calculate_voltage_drop_volts}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="voltage-drop-step3-input" placeholder="${translations[currentLang].introduce_result_volts}" class="guided-input">
                        <button onclick="checkGuidedStep('voltage-drop', 3, ${voltageDrop.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="voltage-drop-step3-feedback" class="feedback"></div>
                    <div id="voltage-drop-step3-result" class="step-result" style="display:none;">
                        <p>ΔV = ${voltageDrop.toFixed(2)} V</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].percentage_calculation}:</strong></p>
                    <p>ΔV% = (ΔV / V) × 100 = (${voltageDrop.toFixed(2)} / ${V}) × 100</p>
                    <p><strong>${translations[currentLang].calculate_voltage_drop_percentage}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="voltage-drop-step4-input" placeholder="${translations[currentLang].introduce_result_percentage}" class="guided-input">
                        <button onclick="checkGuidedStep('voltage-drop', 4, ${voltageDropPercent.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="voltage-drop-step4-feedback" class="feedback"></div>
                    <div id="voltage-drop-step4-result" class="step-result" style="display:none;">
                        <div class="solution">
                            <strong>${translations[currentLang].answer}: ${voltageDropPercent.toFixed(2)}%</strong>
                        </div>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        // Add placeholder functions for other exercise types
        function generateMaxLengthGuidedExercise() {
            const P = getRandomValue([1500, 2000, 3000, 4000, 5000, 6000]);
            const S = getRandomValue([2.5, 4, 6, 10, 16, 25]);
            const V = getRandomValue([230, 400]);
            const isTrifasic = V === 400;
            const maxDropPercent = getRandomValue([3, 5]);
            const material = 'cobre';
            const insulation = 'pvc';
            const conductivity = getConductivity(material, insulation);
            
            const maxVoltageDrop = V * (maxDropPercent / 100);
            let maxLength;
            if (isTrifasic) {
                maxLength = (conductivity * S * V * maxVoltageDrop) / P;
            } else {
                maxLength = (conductivity * S * V * maxVoltageDrop) / (2 * P);
            }
            
            const exercise = guidedExercises['max-length'];
            exercise.currentExercise = { P, S, V, isTrifasic, maxDropPercent, maxVoltageDrop, maxLength, conductivity };
            exercise.stepAttempts = [0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].power}: ${P} W</p>
                    <p>${translations[currentLang].section}: ${S} mm²</p>
                    <p>${translations[currentLang].voltage}: ${V} V (${isTrifasic ? translations[currentLang].trifasic : translations[currentLang].monofasic})</p>
                    <p>${translations[currentLang].max_voltage_drop}: ${maxDropPercent}%</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].max_length}</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].formula}</h3>
                    <p><strong>${translations[currentLang].formula_to_use}:</strong></p>
                    <p>${isTrifasic ? 'L = (γ × S × V × ΔV) / P' : 'L = (γ × S × V × ΔV) / (2 × P)'}</p>
                    <p><strong>${translations[currentLang].where}:</strong></p>
                    <ul>
                        <li>L = ${translations[currentLang].length} (m)</li>
                        <li>γ = ${translations[currentLang].resistivity} (${conductivity} m/Ω·mm²)</li>
                        <li>S = ${translations[currentLang].section} (mm²)</li>
                        <li>V = ${translations[currentLang].voltage} (V)</li>
                        <li>ΔV = ${translations[currentLang].voltage_drop} (V)</li>
                        <li>P = ${translations[currentLang].power} (W)</li>
                    </ul>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].calculate} ΔV</h3>
                    <p><strong>${translations[currentLang].calculate_voltage_drop}:</strong></p>
                    <p>ΔV = ${V} × ${maxDropPercent}% / 100</p>
                    <p><strong>${translations[currentLang].calculate_max_voltage_drop_volts}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="max-length-step3-input" placeholder="${translations[currentLang].introduce_result_volts}" class="guided-input">
                        <button onclick="checkGuidedStep('max-length', 3, ${maxVoltageDrop.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="max-length-step3-feedback" class="feedback"></div>
                    <div id="max-length-step3-result" class="step-result" style="display:none;">
                        <p>ΔV = ${V} × ${maxDropPercent} / 100 = ${maxVoltageDrop.toFixed(2)} V</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].substitute_values}:</strong></p>
                    <p>L = ${isTrifasic ? `(${conductivity} × ${S} × ${V} × ${maxVoltageDrop.toFixed(2)}) / ${P}` : `(${conductivity} × ${S} × ${V} × ${maxVoltageDrop.toFixed(2)}) / (2 × ${P})`}</p>
                    <p><strong>${translations[currentLang].calculate_max_length_result}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="max-length-step4-input" placeholder="${translations[currentLang].introduce_result_meters}" class="guided-input">
                        <button onclick="checkGuidedStep('max-length', 4, ${maxLength.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="max-length-step4-feedback" class="feedback"></div>
                    <div id="max-length-step4-result" class="step-result" style="display:none;">
                        <div class="solution">
                            <strong>${translations[currentLang].answer}: ${maxLength.toFixed(2)} m</strong>
                        </div>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        function generateSectionIntensityGuidedExercise() {
            const I_calculated = getRandomValue([15, 20, 25, 30, 35, 40, 50, 60]);
            const material = 'cobre';
            const insulation = getRandomValue(['pvc', 'xlpe']);
            const method = getRandomValue(['B1', 'B2', 'C', 'D']);
            const isTrifasic = Math.random() > 0.5;
            const conductors = isTrifasic ? '3' : '2';
            const lineType = isTrifasic ? translations[currentLang].trifasic : translations[currentLang].monofasic;
            
            // Encontrar la intensidad normalizada del magnetotérmico
            const I_normalized = NORMALIZED_MAGNETOTERMICOS.find(val => val >= I_calculated) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1];
            
            // Buscar en la tabla de ampacidades
            const table = AMPACIDAD_ITC_BT_19[material]?.[insulation]?.[method]?.[conductors];
            const sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
            
            let selectedSection = null;
            for (const s of sortedSections) {
                if (table[s] >= I_normalized) {
                    selectedSection = s;
                    break;
                }
            }
            
            const maxAmpacity = table[selectedSection];
            
            const exercise = guidedExercises['section-intensity'];
            exercise.currentExercise = { I_calculated, I_normalized, material, insulation, method, lineType, selectedSection, maxAmpacity };
            exercise.stepAttempts = [0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].intensity} calculada: ${I_calculated} A</p>
                    <p>Material: ${translations[currentLang].material_copper}</p>
                    <p>Aislamiento: ${insulation.toUpperCase()}</p>
                    <p>Línea: ${lineType}</p>
                    <p>Método de instalación: ${method}</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].section} mínima</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].normalized_breaker}</h3>
                    <p><strong>${translations[currentLang].normalized_breaker}:</strong></p>
                    <p>Valores normalizados: 10, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125...</p>
                    <p><strong>${translations[currentLang].normalized_magnetothermic_value} ${I_calculated}A?</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-intensity-step2-input" placeholder="${translations[currentLang].introduce_result_amperes}" class="guided-input">
                        <button onclick="checkGuidedStep('section-intensity', 2, ${I_normalized})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-intensity-step2-feedback" class="feedback"></div>
                    <div id="section-intensity-step2-result" class="step-result" style="display:none;">
                        <p>Intensidad normalizada: ${I_normalized} A</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].section_selection}</h3>
                    <p><strong>${translations[currentLang].section_selection}:</strong></p>
                    <p>Material: ${translations[currentLang].material_copper}</p>
                    <p>Aislamiento: ${insulation.toUpperCase()}</p>
                    <p>Método: ${method}</p>
                    <p>Conductores: ${conductors}</p>
                    <p><strong>${translations[currentLang].first_section_supports_current} ${I_normalized}A ${translations[currentLang].or_more_current}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-intensity-step3-input" placeholder="${translations[currentLang].introduce_section_mm2}" class="guided-input">
                        <button onclick="checkGuidedStep('section-intensity', 3, ${selectedSection})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-intensity-step3-feedback" class="feedback"></div>
                    <div id="section-intensity-step3-result" class="step-result" style="display:none;">
                        <p>La sección ${selectedSection} mm² soporta ${maxAmpacity} A</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].answer}:</strong></p>
                    <p>Intensidad calculada: ${I_calculated} A</p>
                    <p>Intensidad normalizada: ${I_normalized} A</p>
                    <p>Sección mínima: ${selectedSection} mm² (soporta ${maxAmpacity} A)</p>
                    <div class="solution">
                        <strong>Sección final: ${selectedSection} mm²</strong>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        function generateSectionBothGuidedExercise() {
            const P = getRandomValue([3000, 4000, 5000, 6000, 8000, 10000]);
            const L = getRandomValue([30, 50, 80, 100, 150]);
            const V = getRandomValue([230, 400]);
            const isTrifasic = V === 400;
            const cosPhi = getRandomValue([0.8, 0.85, 0.9, 0.95, 1.0]);
            const maxDropPercent = getRandomValue([3, 5]);
            const material = 'cobre';
            const insulation = 'pvc';
            const conductivity = getConductivity(material, insulation);
            
            // Cálculo de intensidad
            let I_calculated;
            if (isTrifasic) {
                I_calculated = P / (V * SQRT3 * cosPhi);
            } else {
                I_calculated = P / (V * cosPhi);
            }
            
            // Intensidad normalizada del magnetotérmico
            const I_normalized = NORMALIZED_MAGNETOTERMICOS.find(val => val >= I_calculated) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1];
            
            // Sección por intensidad (usando método B1, 3 conductores)
            const method = 'B1';
            const conductors = isTrifasic ? '3' : '2';
            const table = AMPACIDAD_ITC_BT_19[material]?.[insulation]?.[method]?.[conductors];
            const sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
            
            let sectionByIntensity = null;
            for (const s of sortedSections) {
                if (table[s] >= I_normalized) {
                    sectionByIntensity = s;
                    break;
                }
            }
            
            // Sección por caída de tensión
            const maxVoltageDrop = V * (maxDropPercent / 100);
            let sectionByVoltageDrop;
            if (isTrifasic) {
                sectionByVoltageDrop = (P * L) / (conductivity * V * maxVoltageDrop);
            } else {
                sectionByVoltageDrop = (2 * P * L) / (conductivity * V * maxVoltageDrop);
            }
            
            // Sección normalizada por caída de tensión
            const normalizedSectionByVoltageDrop = NORMALIZED_SECTIONS.find(s => s >= sectionByVoltageDrop) || NORMALIZED_SECTIONS[NORMALIZED_SECTIONS.length - 1];
            
            // Sección final (la mayor)
            const finalSection = Math.max(sectionByIntensity, normalizedSectionByVoltageDrop);
            
            const exercise = guidedExercises['section-both'];
            exercise.currentExercise = { 
                P, L, V, isTrifasic, cosPhi, maxDropPercent, I_calculated, I_normalized, 
                sectionByIntensity, sectionByVoltageDrop, normalizedSectionByVoltageDrop, 
                finalSection, conductivity, maxVoltageDrop 
            };
            exercise.stepAttempts = [0, 0, 0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].power}: ${P} W</p>
                    <p>${translations[currentLang].length}: ${L} m</p>
                    <p>${translations[currentLang].voltage}: ${V} V (${isTrifasic ? translations[currentLang].trifasic : translations[currentLang].monofasic})</p>
                    <p>${translations[currentLang].cosine}: ${cosPhi}</p>
                    <p>${translations[currentLang].max_voltage_drop}: ${maxDropPercent}%</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].section} por intensidad y ΔV</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].intensity_calc}</h3>
                    <p><strong>${translations[currentLang].calculate} ${translations[currentLang].intensity}:</strong></p>
                    <p>${isTrifasic ? `I = P / (V × √3 × cos φ) = ${P} / (${V} × ${SQRT3.toFixed(3)} × ${cosPhi})` : `I = P / (V × cos φ) = ${P} / (${V} × ${cosPhi})`}</p>
                    <p><strong>${translations[currentLang].calculate} ${translations[currentLang].intensity}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-both-step2-input" placeholder="${translations[currentLang].introduce_result_amperes}" class="guided-input">
                        <button onclick="checkGuidedStep('section-both', 2, ${I_calculated.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-both-step2-feedback" class="feedback"></div>
                    <div id="section-both-step2-result" class="step-result" style="display:none;">
                        <p>Intensidad calculada: ${I_calculated.toFixed(2)} A</p>
                        <p>Intensidad normalizada: ${I_normalized} A</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].calc_section_by_intensity}</h3>
                    <p><strong>Sección por intensidad (ITC-BT-19):</strong></p>
                    <p>Intensidad normalizada: ${I_normalized} A</p>
                    <p>Método: ${method}, Conductores: ${conductors}, Material: ${translations[currentLang].material_copper}, Aislamiento: ${insulation.toUpperCase()}</p>
                    <p><strong>${translations[currentLang].min_section_intensity}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-both-step3-input" placeholder="${translations[currentLang].introduce_section_mm2}" class="guided-input">
                        <button onclick="checkGuidedStep('section-both', 3, ${sectionByIntensity})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-both-step3-feedback" class="feedback"></div>
                    <div id="section-both-step3-result" class="step-result" style="display:none;">
                        <p>Sección por intensidad: ${sectionByIntensity} mm²</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].calc_max_length_voltage_drop}</h3>
                    <p><strong>Caída de tensión máxima:</strong></p>
                    <p>ΔV = ${V} × ${maxDropPercent}% / 100 = ${maxVoltageDrop.toFixed(2)} V</p>
                    <p><strong>Sección por caída de tensión:</strong></p>
                    <p>${isTrifasic ? `S = (P × L) / (γ × V × ΔV) = (${P} × ${L}) / (${conductivity} × ${V} × ${maxVoltageDrop.toFixed(2)})` : `S = (2 × P × L) / (γ × V × ΔV) = (2 × ${P} × ${L}) / (${conductivity} × ${V} × ${maxVoltageDrop.toFixed(2)})`}</p>
                    <p><strong>${translations[currentLang].calculated_section} ${translations[currentLang].voltage_drop}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-both-step4-input" placeholder="${translations[currentLang].introduce_section_mm2}" class="guided-input">
                        <button onclick="checkGuidedStep('section-both', 4, ${sectionByVoltageDrop.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-both-step4-feedback" class="feedback"></div>
                    <div id="section-both-step4-result" class="step-result" style="display:none;">
                        <p>Sección calculada por ΔV: ${sectionByVoltageDrop.toFixed(2)} mm²</p>
                        <p>Sección normalizada por ΔV: ${normalizedSectionByVoltageDrop} mm²</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 5: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].choose_larger_section}:</strong></p>
                    <p>Sección por intensidad: ${sectionByIntensity} mm²</p>
                    <p>Sección por caída de tensión: ${normalizedSectionByVoltageDrop} mm²</p>
                    <p><strong>${translations[currentLang].final_section_larger}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="section-both-step5-input" placeholder="${translations[currentLang].introduce_section_mm2}" class="guided-input">
                        <button onclick="checkGuidedStep('section-both', 5, ${finalSection})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="section-both-step5-feedback" class="feedback"></div>
                    <div id="section-both-step5-result" class="step-result" style="display:none;">
                        <div class="solution">
                            <strong>${translations[currentLang].final_correct_section}: ${finalSection} mm²</strong>
                        </div>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }

        function generateMaxLengthBothGuidedExercise() {
            const P = getRandomValue([2000, 3000, 4000, 5000, 6000]);
            const V = getRandomValue([230, 400]);
            const isTrifasic = V === 400;
            const cosPhi = getRandomValue([0.8, 0.85, 0.9, 0.95, 1.0]);
            const maxDropPercent = getRandomValue([3, 5]);
            const material = 'cobre';
            const insulation = 'pvc';
            const conductivity = getConductivity(material, insulation);
            
            // Cálculo de intensidad
            let I_calculated;
            if (isTrifasic) {
                I_calculated = P / (V * SQRT3 * cosPhi);
            } else {
                I_calculated = P / (V * cosPhi);
            }
            
            // Intensidad normalizada del magnetotérmico
            const I_normalized = NORMALIZED_MAGNETOTERMICOS.find(val => val >= I_calculated) || NORMALIZED_MAGNETOTERMICOS[NORMALIZED_MAGNETOTERMICOS.length - 1];
            
            // Sección por intensidad (usando método B1)
            const method = 'B1';
            const conductors = isTrifasic ? '3' : '2';
            const table = AMPACIDAD_ITC_BT_19[material]?.[insulation]?.[method]?.[conductors];
            const sortedSections = Object.keys(table).map(Number).sort((a, b) => a - b);
            
            let sectionByIntensity = null;
            for (const s of sortedSections) {
                if (table[s] >= I_normalized) {
                    sectionByIntensity = s;
                    break;
                }
            }
            
            // Longitud máxima usando la sección por intensidad
            const maxVoltageDrop = V * (maxDropPercent / 100);
            let maxLength;
            if (isTrifasic) {
                maxLength = (conductivity * sectionByIntensity * V * maxVoltageDrop) / P;
            } else {
                maxLength = (conductivity * sectionByIntensity * V * maxVoltageDrop) / (2 * P);
            }
            
            const exercise = guidedExercises['max-length-both'];
            exercise.currentExercise = { 
                P, V, isTrifasic, cosPhi, maxDropPercent, I_calculated, I_normalized, 
                sectionByIntensity, maxLength, conductivity, maxVoltageDrop 
            };
            exercise.stepAttempts = [0, 0, 0, 0, 0]; // Intentos por paso
            exercise.stepResults = [null, null, null, null, null]; // Resultados de cada paso
            
            exercise.steps = [
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 1: ${translations[currentLang].statement}</h3>
                    <p><strong>${translations[currentLang].statement}:</strong></p>
                    <p>${translations[currentLang].power}: ${P} W</p>
                    <p>${translations[currentLang].voltage}: ${V} V (${isTrifasic ? translations[currentLang].trifasic : translations[currentLang].monofasic})</p>
                    <p>${translations[currentLang].cosine}: ${cosPhi}</p>
                    <p>${translations[currentLang].max_voltage_drop}: ${maxDropPercent}%</p>
                    <p><strong>${translations[currentLang].calculate}: ${translations[currentLang].max_length} (considerando intensidad y ΔV)</strong></p>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 2: ${translations[currentLang].intensity_calc}</h3>
                    <p><strong>${translations[currentLang].calculate} ${translations[currentLang].intensity}:</strong></p>
                    <p>${isTrifasic ? `I = P / (V × √3 × cos φ) = ${P} / (${V} × ${SQRT3.toFixed(3)} × ${cosPhi})` : `I = P / (V × cos φ) = ${P} / (${V} × ${cosPhi})`}</p>
                    <p><strong>${translations[currentLang].calculate} ${translations[currentLang].intensity}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="max-length-both-step2-input" placeholder="${translations[currentLang].introduce_result_amperes}" class="guided-input">
                        <button onclick="checkGuidedStep('max-length-both', 2, ${I_calculated.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="max-length-both-step2-feedback" class="feedback"></div>
                    <div id="max-length-both-step2-result" class="step-result" style="display:none;">
                        <p>Intensidad calculada: ${I_calculated.toFixed(2)} A</p>
                        <p>Intensidad normalizada: ${I_normalized} A</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 3: ${translations[currentLang].min_section_intensity}</h3>
                    <p><strong>Sección mínima por intensidad:</strong></p>p>
                    <p>Intensidad normalizada: ${I_normalized} A</p>
                    <p>Método: ${method}, Conductores: ${conductors}, Material: ${translations[currentLang].material_copper}, Aislamiento: ${insulation.toUpperCase()}</p>
                    <p><strong>${translations[currentLang].min_section_intensity} ${I_normalized}A?</strong></p>
                    <div class="input-group">
                        <input type="text" id="max-length-both-step3-input" placeholder="${translations[currentLang].introduce_section_mm2}" class="guided-input">
                        <button onclick="checkGuidedStep('max-length-both', 3, ${sectionByIntensity})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="max-length-both-step3-feedback" class="feedback"></div>
                    <div id="max-length-both-step3-result" class="step-result" style="display:none;">
                        <p>Sección mínima por intensidad: ${sectionByIntensity} mm²</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 4: ${translations[currentLang].calc_max_length_voltage_drop}</h3>
                    <p><strong>Caída de tensión máxima:</strong></p>
                    <p>ΔV = ${V} × ${maxDropPercent}% / 100</p>
                    <p><strong>${translations[currentLang].calculate_max_voltage_drop_volts}:</strong></p>
                    <div class="input-group">
                        <input type="text" id="max-length-both-step4-input" placeholder="${translations[currentLang].introduce_result_volts}" class="guided-input">
                        <button onclick="checkGuidedStep('max-length-both', 4, ${maxVoltageDrop.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="max-length-both-step4-feedback" class="feedback"></div>
                    <div id="max-length-both-step4-result" class="step-result" style="display:none;">
                        <p>ΔV máxima = ${maxVoltageDrop.toFixed(2)} V</p>
                    </div>
                </div>
                `,
                `
                <div class="exercise">
                    <h3>${translations[currentLang].guided_exercise_step} 5: ${translations[currentLang].result}</h3>
                    <p><strong>${translations[currentLang].using_section} ${sectionByIntensity} mm²:</strong></p>
                    <p>${isTrifasic ? `L = (γ × S × V × ΔV) / P = (${conductivity} × ${sectionByIntensity} × ${V} × ${maxVoltageDrop.toFixed(2)}) / ${P}` : `L = (γ × S × V × ΔV) / (2 × P) = (${conductivity} × ${sectionByIntensity} × ${V} × ${maxVoltageDrop.toFixed(2)}) / (2 × ${P})`}</p>
                    <p><strong>${translations[currentLang].what_is_max_length}?</strong></p>
                    <div class="input-group">
                        <input type="text" id="max-length-both-step5-input" placeholder="${translations[currentLang].introduce_result_meters}" class="guided-input">
                        <button onclick="checkGuidedStep('max-length-both', 5, ${maxLength.toFixed(2)})" class="check-btn">${translations[currentLang].verify_button}</button>
                    </div>
                    <div id="max-length-both-step5-feedback" class="feedback"></div>
                    <div id="max-length-both-step5-result" class="step-result" style="display:none;">
                        <div class="solution">
                            <strong>${translations[currentLang].answer}: ${maxLength.toFixed(2)} m</strong>
                            <br><small>(${translations[currentLang].using_section} ${sectionByIntensity} mm²)</small>
                        </div>
                    </div>
                </div>
                `
            ];
            exercise.totalSteps = exercise.steps.length;
        }
    </script>
</body>
</html>
